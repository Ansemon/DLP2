
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; DL MP2 Analysis Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'MIniproyecto2(2)';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Análisis del Modelo DistilBERT para Clasificación de Currículums" href="distilbert_analysis.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="general_analysis.html">
  
  
  
  
  
  
    <p class="title logo__title">DL MP2 Analysis Book</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="general_analysis.html">
                    Análisis General del Sistema de Clasificación Multiclase de Currículums
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="preprocessing_analysis.html">Pipeline de Preprocesamiento y Data Augmentation: Análisis Técnico</a></li>
<li class="toctree-l1"><a class="reference internal" href="bilstm_analysis.html">Análisis del Modelo BiLSTM (Bidirectional Long Short-Term Memory)</a></li>
<li class="toctree-l1"><a class="reference internal" href="cnn1d_analysis.html">Análisis del Modelo CNN-1D (Convolutional Neural Network para Texto)</a></li>
<li class="toctree-l1"><a class="reference internal" href="fasttext_analysis.html">Análisis del Modelo FastText Supervisado</a></li>
<li class="toctree-l1"><a class="reference internal" href="xgboost_analysis.html">Análisis del Modelo XGBoost con TF-IDF</a></li>
<li class="toctree-l1"><a class="reference internal" href="distilbert_analysis.html">Análisis del Modelo DistilBERT para Clasificación de Currículums</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/Ansemon/DLP2" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/Ansemon/DLP2/edit/main/MIniproyecto2(2).ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/Ansemon/DLP2/issues/new?title=Issue%20on%20page%20%2FMIniproyecto2(2).html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/MIniproyecto2(2).ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1><no title></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="simple visible nav section-nav flex-column">
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title all in one</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">html</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TOKENIZERS_PARALLELISM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;WANDB_DISABLED&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">MarianMTModel</span><span class="p">,</span> <span class="n">MarianTokenizer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sentence_transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">SentenceTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics.pairwise</span><span class="w"> </span><span class="kn">import</span> <span class="n">cosine_similarity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">nltk</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nltk.corpus</span><span class="w"> </span><span class="kn">import</span> <span class="n">stopwords</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nltk.stem</span><span class="w"> </span><span class="kn">import</span> <span class="n">WordNetLemmatizer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">GroupShuffleSplit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">LabelEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils.class_weight</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_class_weight</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">StratifiedGroupKFold</span>

<span class="k">def</span><span class="w"> </span><span class="nf">in_colab</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">google.colab</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;stopwords&#39;</span><span class="p">)</span>
<span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;wordnet&#39;</span><span class="p">)</span>
<span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;omw-1.4&#39;</span><span class="p">)</span>

<span class="n">stop_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">))</span>
<span class="n">lemmatizer</span> <span class="o">=</span> <span class="n">WordNetLemmatizer</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">clean_level_basic</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;[^&gt;]+&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;http\S+|www\S+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;－&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;—&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;–&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([a-zA-Z])\*([a-zA-Z])&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1 \2&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\x00-\x1F\x7F-\x9F]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">clean_level_medium</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">clean_level_basic</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\w\s]&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">clean_level_advanced</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">clean_level_medium</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stop_words</span><span class="p">]</span>
    <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="n">lemmatizer</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="s1">&#39;v&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span>
    <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="n">lemmatizer</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span>
    <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>

<span class="n">SRC_LANG</span> <span class="o">=</span> <span class="s2">&quot;en&quot;</span>
<span class="n">INTER_LANG</span> <span class="o">=</span> <span class="s2">&quot;es&quot;</span>
<span class="n">TOLERANCIA</span> <span class="o">=</span> <span class="mf">0.8</span>

<span class="n">MAX_TOKENS_PER_CHUNK</span> <span class="o">=</span> <span class="mi">450</span>
<span class="n">CHUNK_OVERLAP</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">MIN_TEXT_LENGTH</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">MIN_SEMANTIC_SIMILARITY</span> <span class="o">=</span> <span class="mf">0.70</span>
<span class="n">MIN_LENGTH_RATIO</span> <span class="o">=</span> <span class="mf">0.60</span>
<span class="n">MAX_LENGTH_RATIO</span> <span class="o">=</span> <span class="mf">1.50</span>
<span class="n">MAX_AUGMENTATION_RATIO</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Dispositivo: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_translation_models</span><span class="p">(</span><span class="n">src_lang</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="p">,</span> <span class="n">tgt_lang</span><span class="o">=</span><span class="s2">&quot;es&quot;</span><span class="p">):</span>
    <span class="n">model_name_forward</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Helsinki-NLP/opus-mt-</span><span class="si">{</span><span class="n">src_lang</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">tgt_lang</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">model_name_backward</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Helsinki-NLP/opus-mt-</span><span class="si">{</span><span class="n">tgt_lang</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">src_lang</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   [INFO] </span><span class="si">{</span><span class="n">model_name_forward</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">tok_forward</span> <span class="o">=</span> <span class="n">MarianTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name_forward</span><span class="p">)</span>
    <span class="n">model_forward</span> <span class="o">=</span> <span class="n">MarianMTModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name_forward</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   [INFO] </span><span class="si">{</span><span class="n">model_name_backward</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">tok_backward</span> <span class="o">=</span> <span class="n">MarianTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name_backward</span><span class="p">)</span>
    <span class="n">model_backward</span> <span class="o">=</span> <span class="n">MarianMTModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name_backward</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">tok_forward</span><span class="p">,</span> <span class="n">model_forward</span><span class="p">),</span> <span class="p">(</span><span class="n">tok_backward</span><span class="p">,</span> <span class="n">model_backward</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   [INFO] Modelo de embeddings semanticos...&quot;</span><span class="p">)</span>
<span class="n">embedding_model</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="s1">&#39;all-MiniLM-L6-v2&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">embedding_model</span> <span class="o">=</span> <span class="n">embedding_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[SUCCESS] Todos los modelos cargados</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">estimate_tokens</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">*</span> <span class="mf">1.33</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">split_text_into_chunks</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">max_tokens</span><span class="o">=</span><span class="mi">450</span><span class="p">,</span> <span class="n">overlap_words</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">estimate_tokens</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_tokens</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">text</span><span class="p">]</span>

    <span class="n">words_per_chunk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_tokens</span> <span class="o">/</span> <span class="mf">1.33</span><span class="p">)</span>

    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">):</span>
        <span class="n">chunk_words</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">words_per_chunk</span><span class="p">]</span>
        <span class="n">chunk_text</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunk_words</span><span class="p">)</span>

        <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk_text</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">+=</span> <span class="n">words_per_chunk</span> <span class="o">-</span> <span class="n">overlap_words</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">-</span> <span class="n">overlap_words</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">chunks</span>

<span class="k">def</span><span class="w"> </span><span class="nf">merge_chunks</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">merged</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>

    <span class="n">merged</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b(\w+)(\s+\1\b)+&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1&#39;</span><span class="p">,</span> <span class="n">merged</span><span class="p">)</span>

    <span class="n">merged</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">merged</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">merged</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">translate_batch</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="n">all_translations</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span>
            <span class="n">batch</span><span class="p">,</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">max_length</span><span class="o">=</span><span class="mi">512</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">translated</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>

        <span class="n">batch_translations</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">translated</span>
        <span class="p">]</span>
        <span class="n">all_translations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_translations</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">all_translations</span>

<span class="k">def</span><span class="w"> </span><span class="nf">back_translate_with_chunking</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">model_fw</span><span class="p">,</span> <span class="n">model_bw</span><span class="p">):</span>
    <span class="n">tok_fw</span><span class="p">,</span> <span class="n">mod_fw</span> <span class="o">=</span> <span class="n">model_fw</span>
    <span class="n">tok_bw</span><span class="p">,</span> <span class="n">mod_bw</span> <span class="o">=</span> <span class="n">model_bw</span>

    <span class="n">chunks</span> <span class="o">=</span> <span class="n">split_text_into_chunks</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">MAX_TOKENS_PER_CHUNK</span><span class="p">,</span> <span class="n">CHUNK_OVERLAP</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">mid_text</span> <span class="o">=</span> <span class="n">translate_batch</span><span class="p">([</span><span class="n">text</span><span class="p">],</span> <span class="n">tok_fw</span><span class="p">,</span> <span class="n">mod_fw</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">back_text</span> <span class="o">=</span> <span class="n">translate_batch</span><span class="p">([</span><span class="n">mid_text</span><span class="p">],</span> <span class="n">tok_bw</span><span class="p">,</span> <span class="n">mod_bw</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">back_text</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;direct&#39;</span>

    <span class="n">translated_chunks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
        <span class="n">mid_chunk</span> <span class="o">=</span> <span class="n">translate_batch</span><span class="p">([</span><span class="n">chunk</span><span class="p">],</span> <span class="n">tok_fw</span><span class="p">,</span> <span class="n">mod_fw</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">back_chunk</span> <span class="o">=</span> <span class="n">translate_batch</span><span class="p">([</span><span class="n">mid_chunk</span><span class="p">],</span> <span class="n">tok_bw</span><span class="p">,</span> <span class="n">mod_bw</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">translated_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">back_chunk</span><span class="p">)</span>

    <span class="n">final_text</span> <span class="o">=</span> <span class="n">merge_chunks</span><span class="p">(</span><span class="n">translated_chunks</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">final_text</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">),</span> <span class="s1">&#39;chunked&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">semantic_similarity</span><span class="p">(</span><span class="n">text1</span><span class="p">,</span> <span class="n">text2</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">embedding_model</span><span class="o">.</span><span class="n">encode</span><span class="p">([</span><span class="n">text1</span><span class="p">,</span> <span class="n">text2</span><span class="p">],</span> <span class="n">convert_to_tensor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">similarity</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span>
            <span class="n">embeddings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">embeddings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">similarity</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">extract_numbers</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b\d+\b&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">extract_tech_keywords</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">tech_terms</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;java&#39;</span><span class="p">,</span> <span class="s1">&#39;javascript&#39;</span><span class="p">,</span> <span class="s1">&#39;sql&#39;</span><span class="p">,</span> <span class="s1">&#39;c++&#39;</span><span class="p">,</span> <span class="s1">&#39;c#&#39;</span><span class="p">,</span> <span class="s1">&#39;php&#39;</span><span class="p">,</span> <span class="s1">&#39;ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;go&#39;</span><span class="p">,</span>
        <span class="s1">&#39;typescript&#39;</span><span class="p">,</span> <span class="s1">&#39;swift&#39;</span><span class="p">,</span> <span class="s1">&#39;kotlin&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">,</span> <span class="s1">&#39;scala&#39;</span><span class="p">,</span> <span class="s1">&#39;rust&#39;</span><span class="p">,</span> <span class="s1">&#39;perl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;react&#39;</span><span class="p">,</span> <span class="s1">&#39;angular&#39;</span><span class="p">,</span> <span class="s1">&#39;vue&#39;</span><span class="p">,</span> <span class="s1">&#39;django&#39;</span><span class="p">,</span> <span class="s1">&#39;flask&#39;</span><span class="p">,</span> <span class="s1">&#39;spring&#39;</span><span class="p">,</span> <span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="s1">&#39;express&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tensorflow&#39;</span><span class="p">,</span> <span class="s1">&#39;pytorch&#39;</span><span class="p">,</span> <span class="s1">&#39;keras&#39;</span><span class="p">,</span> <span class="s1">&#39;scikit&#39;</span><span class="p">,</span> <span class="s1">&#39;pandas&#39;</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;scipy&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jquery&#39;</span><span class="p">,</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">,</span> <span class="s1">&#39;tailwind&#39;</span><span class="p">,</span>
        <span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;azure&#39;</span><span class="p">,</span> <span class="s1">&#39;gcp&#39;</span><span class="p">,</span> <span class="s1">&#39;docker&#39;</span><span class="p">,</span> <span class="s1">&#39;kubernetes&#39;</span><span class="p">,</span> <span class="s1">&#39;jenkins&#39;</span><span class="p">,</span> <span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;github&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gitlab&#39;</span><span class="p">,</span> <span class="s1">&#39;terraform&#39;</span><span class="p">,</span> <span class="s1">&#39;ansible&#39;</span><span class="p">,</span> <span class="s1">&#39;vagrant&#39;</span><span class="p">,</span> <span class="s1">&#39;circleci&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mysql&#39;</span><span class="p">,</span> <span class="s1">&#39;postgresql&#39;</span><span class="p">,</span> <span class="s1">&#39;mongodb&#39;</span><span class="p">,</span> <span class="s1">&#39;redis&#39;</span><span class="p">,</span> <span class="s1">&#39;oracle&#39;</span><span class="p">,</span> <span class="s1">&#39;cassandra&#39;</span><span class="p">,</span>
        <span class="s1">&#39;elasticsearch&#39;</span><span class="p">,</span> <span class="s1">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="s1">&#39;sqlite&#39;</span><span class="p">,</span> <span class="s1">&#39;mariadb&#39;</span><span class="p">,</span>
        <span class="s1">&#39;excel&#39;</span><span class="p">,</span> <span class="s1">&#39;powerpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;word&#39;</span><span class="p">,</span> <span class="s1">&#39;outlook&#39;</span><span class="p">,</span> <span class="s1">&#39;tableau&#39;</span><span class="p">,</span> <span class="s1">&#39;power bi&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jira&#39;</span><span class="p">,</span> <span class="s1">&#39;confluence&#39;</span><span class="p">,</span> <span class="s1">&#39;slack&#39;</span><span class="p">,</span> <span class="s1">&#39;trello&#39;</span><span class="p">,</span> <span class="s1">&#39;asana&#39;</span><span class="p">,</span>
        <span class="s1">&#39;salesforce&#39;</span><span class="p">,</span> <span class="s1">&#39;sap&#39;</span><span class="p">,</span> <span class="s1">&#39;dynamics&#39;</span><span class="p">,</span> <span class="s1">&#39;workday&#39;</span><span class="p">,</span> <span class="s1">&#39;hubspot&#39;</span><span class="p">,</span> <span class="s1">&#39;zendesk&#39;</span>
        <span class="s1">&#39;agile&#39;</span><span class="p">,</span> <span class="s1">&#39;scrum&#39;</span><span class="p">,</span> <span class="s1">&#39;kanban&#39;</span><span class="p">,</span> <span class="s1">&#39;waterfall&#39;</span><span class="p">,</span> <span class="s1">&#39;devops&#39;</span><span class="p">,</span> <span class="s1">&#39;ci/cd&#39;</span>
    <span class="p">]</span>

    <span class="n">text_lower</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">found</span> <span class="o">=</span> <span class="p">[</span><span class="n">term</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">tech_terms</span> <span class="k">if</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">text_lower</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_augmented_intelligent</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">augmented</span><span class="p">):</span>
    <span class="n">details</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">augmented</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&lt;</span> <span class="n">MIN_TEXT_LENGTH</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Texto muy corto/vacio&quot;</span><span class="p">,</span> <span class="n">details</span>

    <span class="n">len_ratio</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">augmented</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
    <span class="n">details</span><span class="p">[</span><span class="s1">&#39;length_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">len_ratio</span>

    <span class="k">if</span> <span class="n">len_ratio</span> <span class="o">&lt;</span> <span class="n">MIN_LENGTH_RATIO</span> <span class="ow">or</span> <span class="n">len_ratio</span> <span class="o">&gt;</span> <span class="n">MAX_LENGTH_RATIO</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Longitud fuera de rango (</span><span class="si">{</span><span class="n">len_ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">details</span>

    <span class="n">keywords_original</span> <span class="o">=</span> <span class="n">extract_tech_keywords</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
    <span class="n">keywords_augmented</span> <span class="o">=</span> <span class="n">extract_tech_keywords</span><span class="p">(</span><span class="n">augmented</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">keywords_original</span><span class="p">:</span>
        <span class="n">preserved_kw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keywords_original</span> <span class="o">&amp;</span> <span class="n">keywords_augmented</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">keywords_original</span><span class="p">)</span>
        <span class="n">details</span><span class="p">[</span><span class="s1">&#39;keywords_preserved&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preserved_kw</span>

        <span class="k">if</span> <span class="n">preserved_kw</span> <span class="o">&lt;</span> <span class="mf">0.70</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Perdida keywords (</span><span class="si">{</span><span class="n">preserved_kw</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">details</span>

    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Valido&quot;</span><span class="p">,</span> <span class="n">details</span>

<span class="k">def</span><span class="w"> </span><span class="nf">augment_texts_with_chunking_validation</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">model_fw</span><span class="p">,</span> <span class="n">model_bw</span><span class="p">,</span> <span class="n">show_examples</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   [INFO] Procesando </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span><span class="si">}</span><span class="s2"> textos...&quot;</span><span class="p">)</span>

    <span class="n">valid_texts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;total_chunks&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;texts_chunked&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;texts_direct&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;rejected_semantic&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;rejected_numbers&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;rejected_keywords&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;rejected_other&#39;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>

    <span class="n">all_details</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">example_shown</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">original</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;   Traduciendo&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">augmented</span><span class="p">,</span> <span class="n">num_chunks</span><span class="p">,</span> <span class="n">strategy</span> <span class="o">=</span> <span class="n">back_translate_with_chunking</span><span class="p">(</span>
            <span class="n">original</span><span class="p">,</span> <span class="n">model_fw</span><span class="p">,</span> <span class="n">model_bw</span>
        <span class="p">)</span>

        <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_chunks&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">num_chunks</span>
        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;chunked&#39;</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;texts_chunked&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;texts_direct&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">is_valid</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="n">validate_augmented_intelligent</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">augmented</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_valid</span><span class="p">:</span>
            <span class="n">valid_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">augmented</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">all_details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">show_examples</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">example_shown</span> <span class="ow">and</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;chunked&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   [EXAMPLE] Texto chunkeado (</span><span class="si">{</span><span class="n">num_chunks</span><span class="si">}</span><span class="s2"> chunks):&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Original (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">original</span><span class="p">)</span><span class="si">}</span><span class="s2"> chars, </span><span class="si">{</span><span class="n">estimate_tokens</span><span class="p">(</span><span class="n">original</span><span class="p">)</span><span class="si">}</span><span class="s2"> tokens aprox):&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">original</span><span class="p">[:</span><span class="mi">150</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Augmentado (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">augmented</span><span class="p">)</span><span class="si">}</span><span class="s2"> chars):&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">augmented</span><span class="p">[:</span><span class="mi">150</span><span class="p">]</span><span class="si">}</span><span class="s2">...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">example_shown</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">valid_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;similitud&#39;</span> <span class="ow">in</span> <span class="n">reason</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;rejected_semantic&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="s1">&#39;numero&#39;</span> <span class="ow">in</span> <span class="n">reason</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;rejected_numbers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="s1">&#39;keyword&#39;</span> <span class="ow">in</span> <span class="n">reason</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;rejected_keywords&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;rejected_other&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
    <span class="n">valid_pct</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   # RESULTADOS DE VALIDACION:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   [SUCCESS] Validas: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">valid_pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   * ESTADISTICAS DE CHUNKING:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Textos procesados directamente: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;texts_direct&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Textos divididos en chunks: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;texts_chunked&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Total de chunks procesados: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_chunks&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;texts_chunked&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">avg_chunks</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_chunks&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;texts_chunked&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Promedio chunks por texto largo: </span><span class="si">{</span><span class="n">avg_chunks</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">total</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   [ERROR] Rechazadas: </span><span class="si">{</span><span class="n">total</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      - Baja similitud semantica: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;rejected_semantic&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      - Numeros alterados: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;rejected_numbers&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      - Perdida de keywords: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;rejected_keywords&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      - Otras razones: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;rejected_other&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">all_details</span><span class="p">:</span>
        <span class="n">avg_semantic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;semantic_similarity&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_details</span><span class="p">])</span>
        <span class="n">avg_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;length_ratio&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_details</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   [INFO] Metricas promedio (textos validos):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      - Similitud semantica: </span><span class="si">{</span><span class="n">avg_semantic</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      - Ratio de longitud: </span><span class="si">{</span><span class="n">avg_length</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">valid_texts</span><span class="p">,</span> <span class="n">stats</span>

<span class="k">def</span><span class="w"> </span><span class="nf">augment_minority_classes_with_chunking</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">text_col</span><span class="p">,</span> <span class="n">label_col</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* DATA AUGMENTATION CON CHUNKING AUTOMATICO&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>

    <span class="n">df_processed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_processed</span><span class="p">[</span><span class="s1">&#39;original_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_processed</span><span class="o">.</span><span class="n">index</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">df_processed</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">max_count</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">TOLERANCIA</span> <span class="o">*</span> <span class="n">max_count</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># DISTRIBUCION ORIGINAL:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">* Configuracion:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Umbral: </span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> muestras (</span><span class="si">{</span><span class="n">TOLERANCIA</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% del maximo)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Chunking: </span><span class="si">{</span><span class="n">MAX_TOKENS_PER_CHUNK</span><span class="si">}</span><span class="s2"> tokens/chunk, overlap </span><span class="si">{</span><span class="n">CHUNK_OVERLAP</span><span class="si">}</span><span class="s2"> palabras&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Idioma intermedio: </span><span class="si">{</span><span class="n">INTER_LANG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Similitud semantica minima: </span><span class="si">{</span><span class="n">MIN_SEMANTIC_SIMILARITY</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - NO hay filtro de longitud maxima </span><span class="se">\u2705</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - Longitud minima: </span><span class="si">{</span><span class="n">MIN_TEXT_LENGTH</span><span class="si">}</span><span class="s2"> caracteres</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* Cargando modelos de traduccion...&quot;</span><span class="p">)</span>
    <span class="n">model_fw</span><span class="p">,</span> <span class="n">model_bw</span> <span class="o">=</span> <span class="n">load_translation_models</span><span class="p">(</span><span class="n">SRC_LANG</span><span class="p">,</span> <span class="n">INTER_LANG</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\u2705</span><span class="s2"> Modelos listos</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">augmented_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">global_stats</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;@ Procesando clases&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;! CLASE: </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Muestras actuales: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="se">\u2713</span><span class="s2"> Clase balanceada, omitiendo&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">subset_filtered</span> <span class="o">=</span> <span class="n">df_processed</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df_processed</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df_processed</span><span class="p">[</span><span class="n">text_col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">MIN_TEXT_LENGTH</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">filtered_out</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_processed</span><span class="p">[</span><span class="n">df_processed</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">])</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset_filtered</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filtered_out</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ! Filtrados </span><span class="si">{</span><span class="n">filtered_out</span><span class="si">}</span><span class="s2"> textos muy cortos (&lt;</span><span class="si">{</span><span class="n">MIN_TEXT_LENGTH</span><span class="si">}</span><span class="s2"> chars)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset_filtered</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   X Sin textos validos&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">needed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">threshold</span> <span class="o">-</span> <span class="n">count</span><span class="p">)</span>
        <span class="n">max_augment</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="n">MAX_AUGMENTATION_RATIO</span><span class="p">)</span>
        <span class="n">needed</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">needed</span><span class="p">,</span> <span class="n">max_augment</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   * Objetivo: generar </span><span class="si">{</span><span class="n">needed</span><span class="si">}</span><span class="s2"> ejemplos&quot;</span><span class="p">)</span>

        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">needed</span>
        <span class="n">replace</span> <span class="o">=</span> <span class="n">n_samples</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset_filtered</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   * Muestreo con reemplazo&quot;</span><span class="p">)</span>

        <span class="n">sampled_original_data</span> <span class="o">=</span> <span class="n">subset_filtered</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
            <span class="n">n_samples</span><span class="p">,</span>
            <span class="n">replace</span><span class="o">=</span><span class="n">replace</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
        <span class="p">)</span>
        <span class="n">texts_to_augment</span> <span class="o">=</span> <span class="n">sampled_original_data</span><span class="p">[</span><span class="n">text_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">original_ids_for_augmented</span> <span class="o">=</span> <span class="n">sampled_original_data</span><span class="p">[</span><span class="s1">&#39;original_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">augmented_texts</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">augment_texts_with_chunking_validation</span><span class="p">(</span>
            <span class="n">texts_to_augment</span><span class="p">,</span>
            <span class="n">model_fw</span><span class="p">,</span>
            <span class="n">model_bw</span><span class="p">,</span>
            <span class="n">show_examples</span><span class="o">=</span><span class="p">(</span><span class="n">label</span> <span class="o">==</span> <span class="n">dist</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="n">text_col</span><span class="p">:</span> <span class="n">augmented_texts</span><span class="p">,</span>
            <span class="n">label_col</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
            <span class="s1">&#39;original_id&#39;</span><span class="p">:</span> <span class="n">original_ids_for_augmented</span>
        <span class="p">})</span>
        <span class="n">augmented_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_df</span><span class="p">)</span>
        <span class="n">global_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>

        <span class="n">nuevos</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span>
        <span class="n">fallbacks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">augmented_texts</span><span class="p">)</span> <span class="o">-</span> <span class="n">nuevos</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   </span><span class="se">\u2705</span><span class="s2"> RESUMEN:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Validos generados: </span><span class="si">{</span><span class="n">nuevos</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Fallbacks: </span><span class="si">{</span><span class="n">fallbacks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Nuevo total: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> </span><span class="se">\u2192</span><span class="s2"> </span><span class="si">{</span><span class="n">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">augmented_texts</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;@ COMBINANDO DATOS...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">augmented_rows</span><span class="p">:</span>
        <span class="n">augmented_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_processed</span><span class="p">]</span> <span class="o">+</span> <span class="n">augmented_rows</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">total_valid</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">global_stats</span><span class="p">)</span>
        <span class="n">total_generated</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">augmented_rows</span><span class="p">)</span>
        <span class="n">total_chunks</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;total_chunks&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">global_stats</span><span class="p">)</span>
        <span class="n">total_chunked_texts</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;texts_chunked&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">global_stats</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\u2705</span><span class="s2"> AUGMENTACION COMPLETADA&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Ejemplos validos generados: </span><span class="si">{</span><span class="n">total_valid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Total anadido: </span><span class="si">{</span><span class="n">total_generated</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Tasa de exito: </span><span class="si">{</span><span class="n">total_valid</span><span class="o">/</span><span class="n">total_generated</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Textos procesados con chunking: </span><span class="si">{</span><span class="n">total_chunked_texts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Total de chunks procesados: </span><span class="si">{</span><span class="n">total_chunks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">! No se generaron augmentaciones&quot;</span><span class="p">)</span>
        <span class="n">augmented_df</span> <span class="o">=</span> <span class="n">df_processed</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# DISTRIBUCION FINAL:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">augmented_df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">augmented_df</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_data_for_models</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\u2714</span><span class="s2"> Iniciando pipeline de preparacion de datos para modelos...&quot;</span><span class="p">)</span>

    <span class="n">is_colab_env</span> <span class="o">=</span> <span class="n">in_colab</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">is_colab_env</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">google.colab</span><span class="w"> </span><span class="kn">import</span> <span class="n">drive</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;/content/drive/MyDrive&#39;</span><span class="p">):</span>
            <span class="n">drive</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;/content/drive&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   [INFO] Google Drive ya montado.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">original_data_path</span> <span class="o">=</span> <span class="s2">&quot;/content/drive/MyDrive/Resume.csv&quot;</span>
        <span class="n">augmented_data_drive_filepath</span> <span class="o">=</span> <span class="s2">&quot;/content/drive/MyDrive/data_augmented_processed.csv&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">original_data_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;C:\Users\adria\Desktop\Resume.csv&quot;</span>
        <span class="n">augmented_data_drive_filepath</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">augmented_data_local_filepath</span> <span class="o">=</span> <span class="s2">&quot;data_augmented_processed.csv&quot;</span>
    <span class="n">data_augmented</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">source_loaded</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">is_colab_env</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">augmented_data_drive_filepath</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\u2714</span><span class="s2"> Intentando cargar dataframe aumentado desde Google Drive: </span><span class="si">{</span><span class="n">augmented_data_drive_filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">data_augmented</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">augmented_data_drive_filepath</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\u2705</span><span class="s2"> Dataframe aumentado cargado desde Google Drive: </span><span class="si">{</span><span class="n">data_augmented</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> filas, </span><span class="si">{</span><span class="n">data_augmented</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> columnas.&quot;</span><span class="p">)</span>
        <span class="n">source_loaded</span> <span class="o">=</span> <span class="s2">&quot;drive&quot;</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">augmented_data_local_filepath</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\u2714</span><span class="s2"> Intentando cargar dataframe aumentado localmente desde: </span><span class="si">{</span><span class="n">augmented_data_local_filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">data_augmented</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">augmented_data_local_filepath</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\u2705</span><span class="s2"> Dataframe aumentado cargado localmente: </span><span class="si">{</span><span class="n">data_augmented</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> filas, </span><span class="si">{</span><span class="n">data_augmented</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> columnas.&quot;</span><span class="p">)</span>
        <span class="n">source_loaded</span> <span class="o">=</span> <span class="s2">&quot;local&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">! No se encontro &#39;data_augmented_processed.csv&#39; en Drive ni localmente. Iniciando Data Augmentation...&quot;</span><span class="p">)</span>
        <span class="n">data_original</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">original_data_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\u2705</span><span class="s2"> Dataset original cargado para augmentation: </span><span class="si">{</span><span class="n">data_original</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> filas, </span><span class="si">{</span><span class="n">data_original</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> columnas.&quot;</span><span class="p">)</span>

        <span class="n">data_original</span><span class="p">[</span><span class="s2">&quot;Resume_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_original</span><span class="p">[</span><span class="s2">&quot;Resume_str&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">data_original</span><span class="p">[</span><span class="s2">&quot;text_basic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_original</span><span class="p">[</span><span class="s2">&quot;Resume_str&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clean_level_basic</span><span class="p">)</span>
        <span class="n">data_original</span><span class="p">[</span><span class="s2">&quot;text_medium&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_original</span><span class="p">[</span><span class="s2">&quot;Resume_str&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clean_level_medium</span><span class="p">)</span>
        <span class="n">data_original</span><span class="p">[</span><span class="s2">&quot;text_advanced&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_original</span><span class="p">[</span><span class="s2">&quot;Resume_str&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clean_level_advanced</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\u2705</span><span class="s2"> Limpieza inicial de &#39;data_original&#39; completada antes de augmentation.&quot;</span><span class="p">)</span>

        <span class="n">data_augmented</span> <span class="o">=</span> <span class="n">augment_minority_classes_with_chunking</span><span class="p">(</span>
            <span class="n">data_original</span><span class="p">,</span>
            <span class="n">text_col</span><span class="o">=</span><span class="s2">&quot;text_basic&quot;</span><span class="p">,</span>
            <span class="n">label_col</span><span class="o">=</span><span class="s2">&quot;Category&quot;</span>
        <span class="p">)</span>
        <span class="n">source_loaded</span> <span class="o">=</span> <span class="s2">&quot;augmented&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;text_medium&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_augmented</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data_augmented</span><span class="p">[</span><span class="s1">&#39;text_medium&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_augmented</span><span class="p">[</span><span class="s1">&#39;text_basic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clean_level_medium</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="se">\u2713</span><span class="s2"> &#39;text_medium&#39; columna creada y llenada para </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data_augmented</span><span class="p">)</span><span class="si">}</span><span class="s2"> filas (post-augmentation).&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">missing_medium_idx</span> <span class="o">=</span> <span class="n">data_augmented</span><span class="p">[</span><span class="s1">&#39;text_medium&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">missing_medium_idx</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">data_augmented</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_medium_idx</span><span class="p">,</span> <span class="s1">&#39;text_medium&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">data_augmented</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_medium_idx</span><span class="p">,</span> <span class="s1">&#39;text_basic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clean_level_medium</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="se">\u2713</span><span class="s2"> &#39;text_medium&#39; columna llenada para </span><span class="si">{</span><span class="n">missing_medium_idx</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> filas faltantes (post-augmentation).&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;text_advanced&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_augmented</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data_augmented</span><span class="p">[</span><span class="s1">&#39;text_advanced&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_augmented</span><span class="p">[</span><span class="s1">&#39;text_basic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clean_level_advanced</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="se">\u2713</span><span class="s2"> &#39;text_advanced&#39; columna creada y llenada para </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data_augmented</span><span class="p">)</span><span class="si">}</span><span class="s2"> filas (post-augmentation).&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">missing_advanced_idx</span> <span class="o">=</span> <span class="n">data_augmented</span><span class="p">[</span><span class="s1">&#39;text_advanced&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">missing_advanced_idx</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">data_augmented</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_advanced_idx</span><span class="p">,</span> <span class="s1">&#39;text_advanced&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">data_augmented</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_advanced_idx</span><span class="p">,</span> <span class="s1">&#39;text_basic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clean_level_advanced</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="se">\u2713</span><span class="s2"> &#39;text_advanced&#39; columna llenada para </span><span class="si">{</span><span class="n">missing_advanced_idx</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> filas faltantes (post-augmentation).&quot;</span><span class="p">)</span>

        <span class="n">data_augmented</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">augmented_data_local_filepath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\u2714</span><span class="s2"> DataFrame aumentado y guardado localmente en: </span><span class="si">{</span><span class="n">augmented_data_local_filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_colab_env</span> <span class="ow">and</span> <span class="n">augmented_data_drive_filepath</span><span class="p">:</span>
            <span class="n">data_augmented</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">augmented_data_drive_filepath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\u2714</span><span class="s2"> DataFrame aumentado y guardado en Google Drive: </span><span class="si">{</span><span class="n">augmented_data_drive_filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data_augmented</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;original_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_augmented</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data_augmented</span><span class="p">[</span><span class="s1">&#39;original_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_augmented</span><span class="o">.</span><span class="n">index</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   ! &#39;original_id&#39; columna creada con el indice ya que no se encontro en el archivo aumentado.&quot;</span><span class="p">)</span>

        <span class="n">columns_to_check_and_regenerate</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;text_medium&#39;</span><span class="p">:</span> <span class="n">clean_level_medium</span><span class="p">,</span>
            <span class="s1">&#39;text_advanced&#39;</span><span class="p">:</span> <span class="n">clean_level_advanced</span>
        <span class="p">}</span>
        <span class="n">affected_rows_count_total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">regenerated_columns_summary</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">clean_func</span> <span class="ow">in</span> <span class="n">columns_to_check_and_regenerate</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rows_to_process_idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">data_augmented</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">affected_rows_count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">col_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_augmented</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">data_augmented</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">rows_to_process_idx</span> <span class="o">=</span> <span class="n">data_augmented</span><span class="o">.</span><span class="n">index</span>
                <span class="n">affected_rows_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_augmented</span><span class="p">)</span>
                <span class="n">regenerated_columns_summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2">&#39; (missing, </span><span class="si">{</span><span class="n">affected_rows_count</span><span class="si">}</span><span class="s2"> rows)&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">data_augmented</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">rows_to_process_idx</span> <span class="o">=</span> <span class="n">data_augmented</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
                <span class="n">affected_rows_count</span> <span class="o">=</span> <span class="n">rows_to_process_idx</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">regenerated_columns_summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="n">affected_rows_count</span><span class="si">}</span><span class="s2"> nulls)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="se">\u27a0</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2">&#39; columna ya estaba completa.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">rows_to_process_idx</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">data_augmented</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows_to_process_idx</span><span class="p">,</span> <span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">data_augmented</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows_to_process_idx</span><span class="p">,</span> <span class="s1">&#39;text_basic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clean_func</span><span class="p">)</span>
                <span class="n">affected_rows_count_total</span> <span class="o">+=</span> <span class="n">affected_rows_count</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="se">\u2713</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2">&#39; columna llenada/regenerada para </span><span class="si">{</span><span class="n">affected_rows_count</span><span class="si">}</span><span class="s2"> filas.&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">affected_rows_count_total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="se">\u2700</span><span class="s2"> Total de filas afectadas por la regeneracion de columnas: </span><span class="si">{</span><span class="n">affected_rows_count_total</span><span class="si">}</span><span class="s2"> (Detalles: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">regenerated_columns_summary</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source_loaded</span> <span class="o">==</span> <span class="s2">&quot;drive&quot;</span> <span class="ow">and</span> <span class="n">is_colab_env</span><span class="p">:</span>
                <span class="n">data_augmented</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">augmented_data_drive_filepath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="se">\u2714</span><span class="s2"> DataFrame actualizado y guardado en Google Drive: </span><span class="si">{</span><span class="n">augmented_data_drive_filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">source_loaded</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
                <span class="n">data_augmented</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">augmented_data_local_filepath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="se">\u2714</span><span class="s2"> DataFrame actualizado y guardado localmente en: </span><span class="si">{</span><span class="n">augmented_data_local_filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">source_loaded</span> <span class="o">==</span> <span class="s2">&quot;augmented&quot;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_augmented</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">augmented_data_local_filepath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="se">\u2714</span><span class="s2"> DataFrame actualizado y guardado localmente en: </span><span class="si">{</span><span class="n">augmented_data_local_filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_colab_env</span> <span class="ow">and</span> <span class="n">augmented_data_drive_filepath</span><span class="p">:</span>
                    <span class="n">data_augmented</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">augmented_data_drive_filepath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="se">\u2714</span><span class="s2"> DataFrame actualizado y guardado en Google Drive: </span><span class="si">{</span><span class="n">augmented_data_drive_filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   </span><span class="se">\u27a0</span><span class="s2"> Todas las columnas de limpieza (&#39;text_medium&#39;, &#39;text_advanced&#39;) ya estaban completas.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: No se pudo cargar ni generar el dataframe aumentado.&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\u2705</span><span class="s2"> Pipeline de preparacion de datos completado.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_augmented</span><span class="p">,</span> <span class="n">data_augmented</span><span class="p">[</span><span class="s1">&#39;original_id&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">prepare_data_for_training</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">text_col</span><span class="p">,</span> <span class="n">label_col</span><span class="p">,</span> <span class="n">test_size_ratio</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span> <span class="n">val_size_ratio</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">group_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">======================================================&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\u2591\u2591</span><span class="s2"> PREPARANDO DATOS (SPLIT, ENCODING, PESOS DE CLASE)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========================================================</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">text_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">label_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
    <span class="n">y_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clases detectadas: </span><span class="si">{</span><span class="n">num_classes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapping de clases: </span><span class="se">{{</span><span class="s2">i: label for i, label in enumerate(label_encoder.classes_)</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">current_test_size</span> <span class="o">=</span> <span class="n">test_size_ratio</span>
    <span class="n">current_val_size</span> <span class="o">=</span> <span class="n">val_size_ratio</span>

    <span class="k">if</span> <span class="n">n_samples</span> <span class="o">&gt;=</span> <span class="mi">5000</span><span class="p">:</span>
        <span class="n">current_test_size</span> <span class="o">=</span> <span class="mf">0.15</span>
        <span class="n">current_val_size</span> <span class="o">=</span> <span class="mf">0.15</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\u2591</span><span class="s2"> Dataset: </span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s2"> muestras&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Split: </span><span class="si">{</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">current_test_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">current_val_size</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> train, </span><span class="si">{</span><span class="n">current_val_size</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> val, </span><span class="si">{</span><span class="n">current_test_size</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> test</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">group_ids</span><span class="o">.</span><span class="n">values</span>

        <span class="n">unique_group_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;original_id&#39;</span><span class="p">])</span>
        <span class="n">unique_groups</span> <span class="o">=</span> <span class="n">unique_group_data</span><span class="p">[</span><span class="s1">&#39;original_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">unique_group_labels</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">unique_group_data</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\u2702\uFE0F</span><span class="s2"> Dividiendo datos usando Stratified Shuffle Split on unique groups (data leakage prevention and stratification)...&quot;</span><span class="p">)</span>

        <span class="n">train_val_groups_idx</span><span class="p">,</span> <span class="n">test_groups_idx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_groups</span><span class="p">)),</span> <span class="n">unique_group_labels</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="n">current_test_size</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">stratify</span><span class="o">=</span><span class="n">unique_group_labels</span>
        <span class="p">)</span>

        <span class="n">train_val_groups</span> <span class="o">=</span> <span class="n">unique_groups</span><span class="p">[</span><span class="n">train_val_groups_idx</span><span class="p">]</span>
        <span class="n">y_train_val_groups</span> <span class="o">=</span> <span class="n">unique_group_labels</span><span class="p">[</span><span class="n">train_val_groups_idx</span><span class="p">]</span>
        <span class="n">test_groups</span> <span class="o">=</span> <span class="n">unique_groups</span><span class="p">[</span><span class="n">test_groups_idx</span><span class="p">]</span>

        <span class="n">val_size_adjusted</span> <span class="o">=</span> <span class="n">current_val_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">current_test_size</span><span class="p">)</span>
        <span class="n">train_groups_idx</span><span class="p">,</span> <span class="n">val_groups_idx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_val_groups</span><span class="p">)),</span> <span class="n">y_train_val_groups</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="n">val_size_adjusted</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">stratify</span><span class="o">=</span><span class="n">y_train_val_groups</span>
        <span class="p">)</span>

        <span class="n">train_groups</span> <span class="o">=</span> <span class="n">train_val_groups</span><span class="p">[</span><span class="n">train_groups_idx</span><span class="p">]</span>
        <span class="n">val_groups</span> <span class="o">=</span> <span class="n">train_val_groups</span><span class="p">[</span><span class="n">val_groups_idx</span><span class="p">]</span>

        <span class="n">X_train_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;original_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_groups</span><span class="p">)]</span>
        <span class="n">X_val_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;original_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">val_groups</span><span class="p">)]</span>
        <span class="n">X_test_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;original_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">test_groups</span><span class="p">)]</span>

        <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">X_train_data</span><span class="p">[</span><span class="n">text_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train_data</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">X_val_data</span><span class="p">[</span><span class="n">text_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_val_data</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">X_test_data</span><span class="p">[</span><span class="n">text_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_data</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\u2702\uFE0f</span><span class="s2"> Dividiendo datos usando train_test_split (sin group_ids)... &quot;</span><span class="p">)</span>
        <span class="n">X_temp</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_temp</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y_encoded</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="n">current_test_size</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">stratify</span><span class="o">=</span><span class="n">y_encoded</span>
        <span class="p">)</span>

        <span class="n">val_size_adjusted</span> <span class="o">=</span> <span class="n">current_val_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">current_test_size</span><span class="p">)</span>

        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">X_temp</span><span class="p">,</span> <span class="n">y_temp</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="n">val_size_adjusted</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">stratify</span><span class="o">=</span><span class="n">y_temp</span>
        <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\u2705</span><span class="s2"> Train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Val: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Test: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\u2696\uFE0f</span><span class="s2"> Calculando pesos de clase para manejar desbalance...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">class_weights_numpy</span> <span class="o">=</span> <span class="n">compute_class_weight</span><span class="p">(</span>
        <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span>
        <span class="n">classes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">),</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y_train</span>
    <span class="p">)</span>
    <span class="n">class_weights_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">class_weights_numpy</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">sample_weights_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">class_weights_numpy</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">y_train</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pesos por clase (entrenamiento):&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span> <span class="n">class_weights_numpy</span><span class="p">)):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">class_name</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2"> </span><span class="se">\u2192</span><span class="s2"> peso: </span><span class="si">{</span><span class="n">weight</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (n=</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">========================================================</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span>
        <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
        <span class="n">label_encoder</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span>
        <span class="n">class_weights_numpy</span><span class="p">,</span> <span class="n">class_weights_tensor</span><span class="p">,</span>
        <span class="n">sample_weights_train</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[nltk_data] Downloading package stopwords to /root/nltk_data...
[nltk_data]   Package stopwords is already up-to-date!
[nltk_data] Downloading package wordnet to /root/nltk_data...
[nltk_data]   Package wordnet is already up-to-date!
[nltk_data] Downloading package omw-1.4 to /root/nltk_data...
[nltk_data]   Package omw-1.4 is already up-to-date!
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[INFO] Dispositivo: cpu

   [INFO] Modelo de embeddings semanticos...

[SUCCESS] Todos los modelos cargados
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title xgboost</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;WANDB_DISABLED&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xgb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">LabelEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.feature_extraction.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">TfidfVectorizer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">roc_auc_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils.class_weight</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_class_weight</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Imports completados</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">XGB_PARAMS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;objective&#39;</span><span class="p">:</span> <span class="s1">&#39;multi:softprob&#39;</span><span class="p">,</span>
    <span class="s1">&#39;num_class&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
    <span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="s1">&#39;min_child_weight&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="s1">&#39;reg_alpha&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="s1">&#39;reg_lambda&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s1">&#39;tree_method&#39;</span><span class="p">:</span> <span class="s1">&#39;hist&#39;</span><span class="p">,</span>
    <span class="s1">&#39;device&#39;</span><span class="p">:</span> <span class="s1">&#39;cuda&#39;</span><span class="p">,</span>
    <span class="s1">&#39;predictor&#39;</span><span class="p">:</span> <span class="s1">&#39;gpu_predictor&#39;</span><span class="p">,</span>
    <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
    <span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;eval_metric&#39;</span><span class="p">:</span> <span class="s1">&#39;mlogloss&#39;</span>
<span class="p">}</span>


<span class="n">EARLY_STOPPING_ROUNDS</span> <span class="o">=</span> <span class="mi">20</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[?] Verificando GPU para XGBoost...&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">xgb</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;use_rmm&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ GPU disponible para XGBoost</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[?] GPU no disponible, usando CPU&quot;</span><span class="p">)</span>
    <span class="n">XGB_PARAMS</span><span class="p">[</span><span class="s1">&#39;tree_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hist&#39;</span>
    <span class="k">del</span> <span class="n">XGB_PARAMS</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">XGB_PARAMS</span><span class="p">[</span><span class="s1">&#39;predictor&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📊 PREPARACION DE DATOS PARA TF-IDF + XGBOOST&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">data_for_models</span><span class="p">,</span> <span class="n">original_ids_for_models</span> <span class="o">=</span> <span class="n">get_data_for_models</span><span class="p">()</span>

<span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span>
 <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
 <span class="n">label_encoder</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span>
 <span class="n">class_weights_numpy</span><span class="p">,</span> <span class="n">class_weights_tensor</span><span class="p">,</span>
 <span class="n">sample_weights_train</span><span class="p">)</span> <span class="o">=</span> <span class="n">prepare_data_for_training</span><span class="p">(</span>
    <span class="n">data_for_models</span><span class="p">,</span> <span class="s2">&quot;text_advanced&quot;</span><span class="p">,</span> <span class="s2">&quot;Category&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">group_ids</span><span class="o">=</span><span class="n">original_ids_for_models</span>
<span class="p">)</span>

<span class="n">XGB_PARAMS</span><span class="p">[</span><span class="s1">&#39;num_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_classes</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[?] VECTORIZACION TF-IDF&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuracion TF-IDF:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Max features: 10000&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Min DF: 2&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Max DF: 0.95&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - N-gram range: (1, 3)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span>
    <span class="n">max_features</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">min_df</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">max_df</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
    <span class="n">ngram_range</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">sublinear_tf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">strip_accents</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">,</span>
    <span class="n">lowercase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">analyzer</span><span class="o">=</span><span class="s1">&#39;word&#39;</span><span class="p">,</span>
    <span class="n">token_pattern</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\b\w+\b&#39;</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[?] Ajustando TF-IDF en datos de entrenamiento...&quot;</span><span class="p">)</span>
<span class="n">X_train_tfidf</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[?] Transformando datos de validacion y test...&quot;</span><span class="p">)</span>
<span class="n">X_val_tfidf</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
<span class="n">X_test_tfidf</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">✅ Vectorizacion completada&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Vocabulario: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">vocabulary_</span><span class="p">)</span><span class="si">}</span><span class="s2"> palabras&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Shape train: </span><span class="si">{</span><span class="n">X_train_tfidf</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Shape val: </span><span class="si">{</span><span class="n">X_val_tfidf</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Shape test: </span><span class="si">{</span><span class="n">X_test_tfidf</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Sparsity: </span><span class="si">{</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">X_train_tfidf</span><span class="o">.</span><span class="n">nnz</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">X_train_tfidf</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📝 Top 20 features mas importantes:&quot;</span><span class="p">)</span>
<span class="n">tfidf_sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X_train_tfidf</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">top_indices</span> <span class="o">=</span> <span class="n">tfidf_sums</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[</span><span class="o">-</span><span class="mi">20</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">top_indices</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">feature_names</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2"> </span><span class="se">\u2192</span><span class="s2"> </span><span class="si">{</span><span class="n">tfidf_sums</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🚀 ENTRENAMIENTO XGBOOST CON GPU&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hiperparametros XGBoost:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">XGB_PARAMS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[?] Creando DMatrix...&quot;</span><span class="p">)</span>
<span class="n">dtrain</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">DMatrix</span><span class="p">(</span><span class="n">X_train_tfidf</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">sample_weights_train</span><span class="p">)</span>
<span class="n">dval</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">DMatrix</span><span class="p">(</span><span class="n">X_val_tfidf</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y_val</span><span class="p">)</span>
<span class="n">dtest</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">DMatrix</span><span class="p">(</span><span class="n">X_test_tfidf</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ DMatrix creado</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">evallist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dtrain</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">dval</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">)]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🚀 Iniciando entrenamiento...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

<span class="n">evals_result</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
    <span class="n">XGB_PARAMS</span><span class="p">,</span>
    <span class="n">dtrain</span><span class="p">,</span>
    <span class="n">num_boost_round</span><span class="o">=</span><span class="n">XGB_PARAMS</span><span class="p">[</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">],</span>
    <span class="n">evals</span><span class="o">=</span><span class="n">evallist</span><span class="p">,</span>
    <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="n">EARLY_STOPPING_ROUNDS</span><span class="p">,</span>
    <span class="n">evals_result</span><span class="o">=</span><span class="n">evals_result</span><span class="p">,</span>
    <span class="n">verbose_eval</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Entrenamiento completado&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Best iteration: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">best_iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Best score: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[?] Generando graficas...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">epochs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">evals_result</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">][</span><span class="s1">&#39;mlogloss&#39;</span><span class="p">])</span>
<span class="n">x_axis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">evals_result</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">][</span><span class="s1">&#39;mlogloss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">evals_result</span><span class="p">[</span><span class="s1">&#39;eval&#39;</span><span class="p">][</span><span class="s1">&#39;mlogloss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">best_iteration</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Best iteration (</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">best_iteration</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Log Loss&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;XGBoost Training Progress&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[?] Analizando importancia de features...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">importance_dict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_score</span><span class="p">(</span><span class="n">importance_type</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span>
<span class="n">importance_gain</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_score</span><span class="p">(</span><span class="n">importance_type</span><span class="o">=</span><span class="s1">&#39;gain&#39;</span><span class="p">)</span>

<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;f</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">))],</span>
    <span class="s1">&#39;feature_name&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
    <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">importance_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;f</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">))],</span>
    <span class="s1">&#39;gain&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">importance_gain</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;f</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">))]</span>
<span class="p">})</span>

<span class="n">importance_df</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;gain&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top 20 features mas importantes (por gain):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)[[</span><span class="s1">&#39;feature_name&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;gain&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">top_weight</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_weight</span><span class="p">[</span><span class="s1">&#39;feature_name&#39;</span><span class="p">],</span> <span class="n">top_weight</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Weight (frecuencia de uso)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Features por Weight&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

<span class="n">top_gain</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;gain&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">top_gain</span><span class="p">[</span><span class="s1">&#39;feature_name&#39;</span><span class="p">],</span> <span class="n">top_gain</span><span class="p">[</span><span class="s1">&#39;gain&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Gain (ganancia promedio)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 15 Features por Gain&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[?] EVALUACION EN VALIDATION SET&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">y_val_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dval</span><span class="p">)</span>
<span class="n">y_val_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_val_proba</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">val_accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_val_pred</span><span class="p">)</span>
<span class="n">val_f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_val_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
<span class="n">val_f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_val_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>

<span class="n">y_val_one_hot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)[</span><span class="n">y_val</span><span class="p">]</span>
<span class="n">val_roc_auc_ovr</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_val_one_hot</span><span class="p">,</span> <span class="n">y_val_proba</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Metricas en Validation:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Accuracy: </span><span class="si">{</span><span class="n">val_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  F1-Score (macro): </span><span class="si">{</span><span class="n">val_f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  F1-Score (weighted): </span><span class="si">{</span><span class="n">val_f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ROC AUC (OvR): </span><span class="si">{</span><span class="n">val_roc_auc_ovr</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[?] EVALUACION EN TEST SET&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">y_test_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dtest</span><span class="p">)</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_test_proba</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">test_accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">test_f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
<span class="n">test_f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>

<span class="n">y_test_one_hot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)[</span><span class="n">y_test</span><span class="p">]</span>
<span class="n">test_roc_auc_ovr</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test_one_hot</span><span class="p">,</span> <span class="n">y_test_proba</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[?] METRICAS EN TEST SET:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Accuracy: </span><span class="si">{</span><span class="n">test_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  F1-Score (macro): </span><span class="si">{</span><span class="n">test_f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  F1-Score (weighted): </span><span class="si">{</span><span class="n">test_f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ROC AUC (OvR): </span><span class="si">{</span><span class="n">test_roc_auc_ovr</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;REPORTE DE CLASIFICACION DETALLADO&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span>
    <span class="n">y_test</span><span class="p">,</span>
    <span class="n">y_test_pred</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_classes</span><span class="p">),</span>
    <span class="n">target_names</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span>
    <span class="n">digits</span><span class="o">=</span><span class="mi">4</span>
<span class="p">))</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[?] Generando matriz de confusion...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_classes</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
    <span class="n">cm</span><span class="p">,</span>
    <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span>
    <span class="n">xticklabels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span>
    <span class="n">yticklabels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span>
    <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Numero de predicciones&#39;</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusion - TF-IDF + XGBoost&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Verdadero&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicho&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[?] ANALISIS DETALLADO POR CLASE&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span>

<span class="n">precision_per_class</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_classes</span><span class="p">),</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall_per_class</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_classes</span><span class="p">),</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1_per_class</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_classes</span><span class="p">),</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">analysis_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Clase&#39;</span><span class="p">:</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span>
    <span class="s1">&#39;Muestras Test&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">precision_per_class</span><span class="p">,</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">recall_per_class</span><span class="p">,</span>
    <span class="s1">&#39;F1-Score&#39;</span><span class="p">:</span> <span class="n">f1_per_class</span>
<span class="p">})</span>

<span class="n">analysis_df</span> <span class="o">=</span> <span class="n">analysis_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">analysis_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[?] Clases con F1-Score &lt; 0.70:&quot;</span><span class="p">)</span>
<span class="n">problematic</span> <span class="o">=</span> <span class="n">analysis_df</span><span class="p">[</span><span class="n">analysis_df</span><span class="p">[</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.70</span><span class="p">]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">problematic</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">problematic</span><span class="p">[[</span><span class="s1">&#39;Clase&#39;</span><span class="p">,</span> <span class="s1">&#39;Muestras Test&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   ✅ Todas las clases tienen F1-Score &gt;= 0.70&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[?] GUARDANDO MODELO Y ARTEFACTOS&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="s1">&#39;xgboost_model.json&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Modelo XGBoost guardado: xgboost_model.json&quot;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;tfidf_vectorizer.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">vectorizer</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Vectorizador TF-IDF guardado: tfidf_vectorizer.pkl&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;label_encoder.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">label_encoder</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Label encoder guardado: label_encoder.pkl&quot;</span><span class="p">)</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="s1">&#39;min_df&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;max_df&#39;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
    <span class="s1">&#39;ngram_range&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="s1">&#39;num_classes&#39;</span><span class="p">:</span> <span class="n">num_classes</span><span class="p">,</span>
    <span class="s1">&#39;class_names&#39;</span><span class="p">:</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="s1">&#39;xgb_params&#39;</span><span class="p">:</span> <span class="n">XGB_PARAMS</span><span class="p">,</span>
    <span class="s1">&#39;vocab_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">vocabulary_</span><span class="p">),</span>
    <span class="s1">&#39;test_accuracy&#39;</span><span class="p">:</span> <span class="n">test_accuracy</span><span class="p">,</span>
    <span class="s1">&#39;test_f1_macro&#39;</span><span class="p">:</span> <span class="n">test_f1_macro</span><span class="p">,</span>
    <span class="s1">&#39;test_f1_weighted&#39;</span><span class="p">:</span> <span class="n">test_f1_weighted</span><span class="p">,</span>
    <span class="s1">&#39;test_roc_auc_ovr&#39;</span><span class="p">:</span> <span class="n">test_roc_auc_ovr</span>
<span class="p">}</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;model_config.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Configuracion guardada: model_config.json&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🎉 PROCESO COMPLETADO&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📝 Ejemplo de funcion de prediccion:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">predict_resume_category</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">model_path</span><span class="o">=</span><span class="s1">&#39;xgboost_model.json&#39;</span><span class="p">,</span>
                           <span class="n">vectorizer_path</span><span class="o">=</span><span class="s1">&#39;tfidf_vectorizer.pkl&#39;</span><span class="p">,</span>
                           <span class="n">label_encoder_path</span><span class="o">=</span><span class="s1">&#39;label_encoder.pkl&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Predice la categoria de un CV.</span>

<span class="sd">    Args:</span>
<span class="sd">        text: Texto del CV (debe estar limpio con text_advanced)</span>
<span class="sd">        model_path: Ruta al modelo XGBoost</span>
<span class="sd">        vectorizer_path: Ruta al vectorizador TF-IDF</span>
<span class="sd">        label_encoder_path: Ruta al label encoder</span>

<span class="sd">    Returns:</span>
<span class="sd">        Categoria predicha y probabilidades</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xgb</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">Booster</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">vectorizer_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">label_encoder_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">label_encoder</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">text_tfidf</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">text</span><span class="p">])</span>
    <span class="n">dmatrix</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">DMatrix</span><span class="p">(</span><span class="n">text_tfidf</span><span class="p">)</span>

    <span class="n">pred_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dmatrix</span><span class="p">)</span>
    <span class="n">pred_label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pred_proba</span><span class="p">))</span>
    <span class="n">pred_category</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">([</span><span class="n">pred_label</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">pred_category</span><span class="p">,</span> <span class="n">pred_proba</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2"># Ejemplo de uso:</span>
<span class="s2">from tu_modulo import predict_resume_category</span>

<span class="s2">texto_cv = &quot;tu texto de cv limpio con text_advanced...&quot;</span>
<span class="s2">categoria, probabilidades = predict_resume_category(texto_cv)</span>
<span class="s2">print(f&quot;Categoria predicha: </span><span class="si">{categoria}</span><span class="s2">&quot;)</span>
<span class="s2">print(f&quot;Probabilidades: </span><span class="si">{probabilidades}</span><span class="s2">&quot;)</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Todo listo para usar el modelo&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Imports completados

[?] Verificando GPU para XGBoost...
✅ GPU disponible para XGBoost

======================================================================
📊 PREPARACION DE DATOS PARA TF-IDF + XGBOOST
======================================================================


✔ Iniciando pipeline de preparacion de datos para modelos...
Mounted at /content/drive
✔ Intentando cargar dataframe aumentado desde Google Drive: /content/drive/MyDrive/data_augmented_processed.csv
✅ Dataframe aumentado cargado desde Google Drive: 2621 filas, 8 columnas.
   ✓ &#39;text_medium&#39; columna llenada/regenerada para 1 filas.
   ✓ &#39;text_advanced&#39; columna llenada/regenerada para 1 filas.
   ✀ Total de filas afectadas por la regeneracion de columnas: 2 (Detalles: &#39;text_medium&#39; (1 nulls), &#39;text_advanced&#39; (1 nulls))

   ✔ DataFrame actualizado y guardado en Google Drive: /content/drive/MyDrive/data_augmented_processed.csv
✅ Pipeline de preparacion de datos completado.

======================================================
░░ PREPARANDO DATOS (SPLIT, ENCODING, PESOS DE CLASE)
========================================================

Clases detectadas: 24
Mapping de clases: {i: label for i, label in enumerate(label_encoder.classes_)}

░ Dataset: 2621 muestras
   Split: 80% train, 10% val, 10% test

✂️ Dividiendo datos usando Stratified Shuffle Split on unique groups (data leakage prevention and stratification)...
✅ Train: 2104 | Val: 262 | Test: 255

⚖️ Calculando pesos de clase para manejar desbalance...

Pesos por clase (entrenamiento):
  ACCOUNTANT           → peso: 0.933 (n=94)
  ADVOCATE             → peso: 0.933 (n=94)
  AGRICULTURE          → peso: 1.154 (n=76)
  APPAREL              → peso: 1.139 (n=77)
  ARTS                 → peso: 1.056 (n=83)
  AUTOMOBILE           → peso: 1.056 (n=83)
  AVIATION             → peso: 0.943 (n=93)
  BANKING              → peso: 0.953 (n=92)
  BPO                  → peso: 1.538 (n=57)
  BUSINESS-DEVELOPMENT → peso: 0.913 (n=96)
  CHEF                 → peso: 0.933 (n=94)
  CONSTRUCTION         → peso: 0.974 (n=90)
  CONSULTANT           → peso: 0.943 (n=93)
  DESIGNER             → peso: 1.031 (n=85)
  DIGITAL-MEDIA        → peso: 1.139 (n=77)
  ENGINEERING          → peso: 0.933 (n=94)
  FINANCE              → peso: 0.933 (n=94)
  FITNESS              → peso: 0.943 (n=93)
  HEALTHCARE           → peso: 0.953 (n=92)
  HR                   → peso: 0.996 (n=88)
  INFORMATION-TECHNOLOGY → peso: 0.913 (n=96)
  PUBLIC-RELATIONS     → peso: 0.985 (n=89)
  SALES                → peso: 0.953 (n=92)
  TEACHER              → peso: 1.069 (n=82)

========================================================

======================================================================
[?] VECTORIZACION TF-IDF
======================================================================

Configuracion TF-IDF:
  - Max features: 10000
  - Min DF: 2
  - Max DF: 0.95
  - N-gram range: (1, 3)

[?] Ajustando TF-IDF en datos de entrenamiento...
[?] Transformando datos de validacion y test...

✅ Vectorizacion completada
   Vocabulario: 10000 palabras
   Shape train: (2104, 10000)
   Shape val: (262, 10000)
   Shape test: (255, 10000)
   Sparsity: 96.15%


📝 Top 20 features mas importantes:
   city state           → 60.48
   name city            → 53.77
   company name city    → 53.76
   name city state      → 53.46
   management           → 51.79
   customer             → 51.35
   service              → 47.90
   sale                 → 46.26
   work                 → 45.73
   business             → 44.04
   train                → 42.33
   team                 → 42.17
   client               → 42.09
   process              → 41.72
   manage               → 41.69
   project              → 41.57
   plan                 → 40.63
   account              → 40.28
   new                  → 40.10
   system               → 39.91

======================================================================

======================================================================
🚀 ENTRENAMIENTO XGBOOST CON GPU
======================================================================

Hiperparametros XGBoost:
  objective            = multi:softprob
  num_class            = 24
  max_depth            = 6
  learning_rate        = 0.1
  n_estimators         = 300
  subsample            = 0.8
  colsample_bytree     = 0.8
  min_child_weight     = 3
  gamma                = 0.1
  reg_alpha            = 0.1
  reg_lambda           = 1.0
  tree_method          = hist
  device               = cuda
  predictor            = gpu_predictor
  random_state         = 42
  n_jobs               = -1
  eval_metric          = mlogloss

[?] Creando DMatrix...
✅ DMatrix creado

🚀 Iniciando entrenamiento...

----------------------------------------------------------------------
[0]	train-mlogloss:2.70658	eval-mlogloss:2.73024
[10]	train-mlogloss:1.13811	eval-mlogloss:1.52385
[20]	train-mlogloss:0.62177	eval-mlogloss:1.16868
[30]	train-mlogloss:0.37369	eval-mlogloss:1.02433
[40]	train-mlogloss:0.24074	eval-mlogloss:0.94638
[50]	train-mlogloss:0.16591	eval-mlogloss:0.89794
[60]	train-mlogloss:0.12124	eval-mlogloss:0.87901
[70]	train-mlogloss:0.09416	eval-mlogloss:0.86581
[80]	train-mlogloss:0.07706	eval-mlogloss:0.85845
[90]	train-mlogloss:0.06554	eval-mlogloss:0.85879
[100]	train-mlogloss:0.05754	eval-mlogloss:0.86084
[105]	train-mlogloss:0.05441	eval-mlogloss:0.86212

----------------------------------------------------------------------
✅ Entrenamiento completado
   Best iteration: 85
   Best score: 0.8547

[?] Generando graficas...
</pre></div>
</div>
<img alt="_images/b7706802cad90d696f138b410eee04df4f526cf85f346d55aa37c932c6c9a231.png" src="_images/b7706802cad90d696f138b410eee04df4f526cf85f346d55aa37c932c6c9a231.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[?] Analizando importancia de features...

Top 20 features mas importantes (por gain):

                     feature_name  weight       gain
                             menu     1.0 130.915619
experience information technology     1.0 107.603912
                           flight     1.0  81.737961
                 personal trainer     1.0  75.915527
             construction project     5.0  65.058884
              experience business     3.0  51.903027
                         one year     1.0  51.475227
                         hardware     1.0  45.625542
                           farmer     1.0  43.773235
                   tight deadline     1.0  41.492493
                             navy     1.0  40.493908
           service representative     1.0  40.035194
                             idea     1.0  34.996696
                              lan     1.0  32.101025
                      eligibility     1.0  31.746349
                              aaa     1.0  29.703249
                             chef    64.0  28.135826
                    data analysis     1.0  27.613165
                         designer    78.0  27.304815
                    february 2014     3.0  26.286623
</pre></div>
</div>
<img alt="_images/9f347fa8d2adb4a76b275bf9f039981666c02890fbfbd643eec5c181e62e4ae0.png" src="_images/9f347fa8d2adb4a76b275bf9f039981666c02890fbfbd643eec5c181e62e4ae0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>======================================================================
[?] EVALUACION EN VALIDATION SET
======================================================================

Metricas en Validation:

  Accuracy: 0.7328
  F1-Score (macro): 0.6872
  F1-Score (weighted): 0.7143
  ROC AUC (OvR): 0.9732

======================================================================
[?] EVALUACION EN TEST SET
======================================================================

[?] METRICAS EN TEST SET:

  Accuracy: 0.7922
  F1-Score (macro): 0.7606
  F1-Score (weighted): 0.7849
  ROC AUC (OvR): 0.9816

======================================================================
REPORTE DE CLASIFICACION DETALLADO
======================================================================

                        precision    recall  f1-score   support

            ACCOUNTANT     0.7692    0.8333    0.8000        12
              ADVOCATE     0.6875    0.9167    0.7857        12
           AGRICULTURE     1.0000    0.6667    0.8000         9
               APPAREL     1.0000    0.5000    0.6667        10
                  ARTS     0.5000    0.5000    0.5000        10
            AUTOMOBILE     0.5000    0.2000    0.2857         5
              AVIATION     0.8333    0.8333    0.8333        12
               BANKING     0.8000    0.7273    0.7619        11
                   BPO     1.0000    0.2500    0.4000         4
  BUSINESS-DEVELOPMENT     0.8571    1.0000    0.9231        12
                  CHEF     0.7273    0.6667    0.6957        12
          CONSTRUCTION     0.9167    1.0000    0.9565        11
            CONSULTANT     0.7273    0.7273    0.7273        11
              DESIGNER     0.9167    1.0000    0.9565        11
         DIGITAL-MEDIA     0.8000    0.8000    0.8000        10
           ENGINEERING     0.6875    0.9167    0.7857        12
               FINANCE     0.9000    0.7500    0.8182        12
               FITNESS     0.7692    0.8333    0.8000        12
            HEALTHCARE     1.0000    0.7273    0.8421        11
                    HR     1.0000    0.9091    0.9524        11
INFORMATION-TECHNOLOGY     0.8571    1.0000    0.9231        12
      PUBLIC-RELATIONS     0.7692    0.9091    0.8333        11
                 SALES     0.6667    0.8333    0.7407        12
               TEACHER     0.6364    0.7000    0.6667        10

              accuracy                         0.7922       255
             macro avg     0.8051    0.7583    0.7606       255
          weighted avg     0.8053    0.7922    0.7849       255


[?] Generando matriz de confusion...
</pre></div>
</div>
<img alt="_images/12d5cc07068bce23d51dbd61cf37034292409ce5eec3e29e62d4fd563642581f.png" src="_images/12d5cc07068bce23d51dbd61cf37034292409ce5eec3e29e62d4fd563642581f.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>======================================================================
[?] ANALISIS DETALLADO POR CLASE
======================================================================

                 Clase  Muestras Test  Precision   Recall  F1-Score
              DESIGNER             11   0.916667 1.000000  0.956522
          CONSTRUCTION             11   0.916667 1.000000  0.956522
                    HR             11   1.000000 0.909091  0.952381
  BUSINESS-DEVELOPMENT             12   0.857143 1.000000  0.923077
INFORMATION-TECHNOLOGY             12   0.857143 1.000000  0.923077
            HEALTHCARE             11   1.000000 0.727273  0.842105
              AVIATION             12   0.833333 0.833333  0.833333
      PUBLIC-RELATIONS             11   0.769231 0.909091  0.833333
               FINANCE             12   0.900000 0.750000  0.818182
         DIGITAL-MEDIA             10   0.800000 0.800000  0.800000
            ACCOUNTANT             12   0.769231 0.833333  0.800000
               FITNESS             12   0.769231 0.833333  0.800000
           AGRICULTURE              9   1.000000 0.666667  0.800000
              ADVOCATE             12   0.687500 0.916667  0.785714
           ENGINEERING             12   0.687500 0.916667  0.785714
               BANKING             11   0.800000 0.727273  0.761905
                 SALES             12   0.666667 0.833333  0.740741
            CONSULTANT             11   0.727273 0.727273  0.727273
                  CHEF             12   0.727273 0.666667  0.695652
               APPAREL             10   1.000000 0.500000  0.666667
               TEACHER             10   0.636364 0.700000  0.666667
                  ARTS             10   0.500000 0.500000  0.500000
                   BPO              4   1.000000 0.250000  0.400000
            AUTOMOBILE              5   0.500000 0.200000  0.285714

[?] Clases con F1-Score &lt; 0.70:
     Clase  Muestras Test  F1-Score
      CHEF             12  0.695652
   APPAREL             10  0.666667
   TEACHER             10  0.666667
      ARTS             10  0.500000
       BPO              4  0.400000
AUTOMOBILE              5  0.285714

======================================================================
[?] GUARDANDO MODELO Y ARTEFACTOS
======================================================================

✅ Modelo XGBoost guardado: xgboost_model.json
✅ Vectorizador TF-IDF guardado: tfidf_vectorizer.pkl
✅ Label encoder guardado: label_encoder.pkl
✅ Configuracion guardada: model_config.json

======================================================================
🎉 PROCESO COMPLETADO
======================================================================

📝 Ejemplo de funcion de prediccion:


# Ejemplo de uso:
from tu_modulo import predict_resume_category

texto_cv = &quot;tu texto de cv limpio con text_advanced...&quot;
categoria, probabilidades = predict_resume_category(texto_cv)
print(f&quot;Categoria predicha: {categoria}&quot;)
print(f&quot;Probabilidades: {probabilidades}&quot;)

✅ Todo listo para usar el modelo
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title CNN</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">gensim</span> <span class="n">torch</span> <span class="n">scikit</span><span class="o">-</span><span class="n">learn</span> <span class="n">matplotlib</span> <span class="n">seaborn</span> <span class="o">-</span><span class="n">q</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;WANDB_DISABLED&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">roc_auc_score</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">gensim.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Word2Vec</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gensim.downloader</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">api</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Imports completados</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">MAX_SEQUENCE_LENGTH</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">EMBEDDING_DIM</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">VOCAB_SIZE</span> <span class="o">=</span> <span class="mi">50000</span>

<span class="n">NUM_FILTERS</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">KERNEL_SIZES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">DROPOUT_RATE</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">LEARNING_RATE</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">EARLY_STOPPING_PATIENCE</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Dispositivo: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📊 PREPARACION DE DATOS PARA CNN-1D&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">data_for_models</span><span class="p">,</span> <span class="n">original_ids_for_models</span> <span class="o">=</span> <span class="n">get_data_for_models</span><span class="p">()</span>

<span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span>
 <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
 <span class="n">label_encoder</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span>
 <span class="n">class_weights_numpy</span><span class="p">,</span> <span class="n">class_weights_tensor</span><span class="p">,</span>
 <span class="n">sample_weights_train</span><span class="p">)</span> <span class="o">=</span> <span class="n">prepare_data_for_training</span><span class="p">(</span>
    <span class="n">data_for_models</span><span class="p">,</span> <span class="s2">&quot;text_advanced&quot;</span><span class="p">,</span> <span class="s2">&quot;Category&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">group_ids</span><span class="o">=</span><span class="n">original_ids_for_models</span>
<span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📝 Tokenizando y construyendo vocabulario...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="n">train_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">X_train</span><span class="p">]</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>

<span class="n">word_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
<span class="k">for</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">train_tokens</span><span class="p">:</span>
    <span class="n">word_counts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

<span class="n">vocab</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;PAD&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;UNK&gt;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">word_counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="n">VOCAB_SIZE</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)]</span>
<span class="n">word_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vocab</span><span class="p">)}</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Vocabulario construido: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span><span class="si">}</span><span class="s2"> palabras&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Palabras mas comunes: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">word_counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">text_to_sequence</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">max_length</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convierte texto a secuencia de indices.&quot;&quot;&quot;</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="p">[</span><span class="n">word_to_idx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">[</span><span class="s1">&#39;&lt;UNK&gt;&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_length</span><span class="p">:</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span> <span class="o">+</span> <span class="p">[</span><span class="n">word_to_idx</span><span class="p">[</span><span class="s1">&#39;&lt;PAD&gt;&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">[:</span><span class="n">max_length</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">sequence</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔢 Convirtiendo textos a secuencias...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">X_train_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">text_to_sequence</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">MAX_SEQUENCE_LENGTH</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">X_train</span><span class="p">])</span>
<span class="n">X_val_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">text_to_sequence</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">MAX_SEQUENCE_LENGTH</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">X_val</span><span class="p">])</span>
<span class="n">X_test_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">text_to_sequence</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">MAX_SEQUENCE_LENGTH</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">X_test</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Secuencias creadas&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Shape train: </span><span class="si">{</span><span class="n">X_train_seq</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Shape val: </span><span class="si">{</span><span class="n">X_val_seq</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Shape test: </span><span class="si">{</span><span class="n">X_test_seq</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🎯 CARGANDO EMBEDDINGS PREENTRENADOS&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selecciona embeddings preentrenados:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  1. Word2Vec GoogleNews (300d) - ~1.5GB&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  2. GloVe Twitter (200d) - mas rapido&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  3. Entrenar Word2Vec localmente (mas rapido, pero menos robusto)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">EMBEDDING_CHOICE</span> <span class="o">=</span> <span class="mi">3</span>

<span class="k">if</span> <span class="n">EMBEDDING_CHOICE</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📥 Descargando Word2Vec GoogleNews (esto puede tardar varios minutos)...&quot;</span><span class="p">)</span>
    <span class="n">pretrained_embeddings</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;word2vec-google-news-300&quot;</span><span class="p">)</span>
    <span class="n">EMBEDDING_DIM</span> <span class="o">=</span> <span class="mi">300</span>

<span class="k">elif</span> <span class="n">EMBEDDING_CHOICE</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📥 Descargando GloVe Twitter...&quot;</span><span class="p">)</span>
    <span class="n">pretrained_embeddings</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;glove-twitter-200&quot;</span><span class="p">)</span>
    <span class="n">EMBEDDING_DIM</span> <span class="o">=</span> <span class="mi">200</span>

<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔄 Entrenando Word2Vec localmente en tus datos...&quot;</span><span class="p">)</span>
    <span class="n">pretrained_embeddings</span> <span class="o">=</span> <span class="n">Word2Vec</span><span class="p">(</span>
        <span class="n">sentences</span><span class="o">=</span><span class="n">train_tokens</span><span class="p">,</span>
        <span class="n">vector_size</span><span class="o">=</span><span class="n">EMBEDDING_DIM</span><span class="p">,</span>
        <span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">min_count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span>
    <span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Embeddings cargados</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🏗️  Creando matriz de embeddings para vocabulario...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">embedding_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">),</span> <span class="n">EMBEDDING_DIM</span><span class="p">))</span>
<span class="n">found_words</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">word_to_idx</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&lt;PAD&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;UNK&gt;&#39;</span><span class="p">]:</span>
        <span class="k">continue</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">EMBEDDING_CHOICE</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">embedding_vector</span> <span class="o">=</span> <span class="n">pretrained_embeddings</span><span class="o">.</span><span class="n">wv</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">embedding_vector</span> <span class="o">=</span> <span class="n">pretrained_embeddings</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>

        <span class="n">embedding_matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">embedding_vector</span>
        <span class="n">found_words</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">embedding_matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">EMBEDDING_DIM</span><span class="p">,))</span>

<span class="n">coverage</span> <span class="o">=</span> <span class="n">found_words</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Matriz de embeddings creada&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Cobertura: </span><span class="si">{</span><span class="n">found_words</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span><span class="si">}</span><span class="s2"> palabras (</span><span class="si">{</span><span class="n">coverage</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Shape: </span><span class="si">{</span><span class="n">embedding_matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TextDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequences</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">TextDataset</span><span class="p">(</span><span class="n">X_train_seq</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">val_dataset</span> <span class="o">=</span> <span class="n">TextDataset</span><span class="p">(</span><span class="n">X_val_seq</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">TextDataset</span><span class="p">(</span><span class="n">X_test_seq</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ DataLoaders creados&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Train batches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Val batches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_loader</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Test batches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🏗️ CONSTRUYENDO MODELO CNN-1D&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TextCNN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span>
                 <span class="n">num_filters</span><span class="p">,</span> <span class="n">kernel_sizes</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="p">,</span>
                 <span class="n">pretrained_embeddings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freeze_embeddings</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TextCNN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">padding_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pretrained_embeddings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">pretrained_embeddings</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">freeze_embeddings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">convs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span>
                <span class="n">in_channels</span><span class="o">=</span><span class="n">embedding_dim</span><span class="p">,</span>
                <span class="n">out_channels</span><span class="o">=</span><span class="n">num_filters</span><span class="p">,</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="n">k</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kernel_sizes</span>
        <span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kernel_sizes</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_filters</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">embedded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">embedded</span> <span class="o">=</span> <span class="n">embedded</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">conv_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">conv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">convs</span><span class="p">:</span>
            <span class="n">conv_out</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">conv</span><span class="p">(</span><span class="n">embedded</span><span class="p">))</span>

            <span class="n">pooled</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">max_pool1d</span><span class="p">(</span><span class="n">conv_out</span><span class="p">,</span> <span class="n">conv_out</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

            <span class="n">conv_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pooled</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

        <span class="n">concatenated</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">conv_outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

        <span class="n">dropped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">concatenated</span><span class="p">)</span>

        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">dropped</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">logits</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">TextCNN</span><span class="p">(</span>
    <span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">),</span>
    <span class="n">embedding_dim</span><span class="o">=</span><span class="n">EMBEDDING_DIM</span><span class="p">,</span>
    <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span>
    <span class="n">num_filters</span><span class="o">=</span><span class="n">NUM_FILTERS</span><span class="p">,</span>
    <span class="n">kernel_sizes</span><span class="o">=</span><span class="n">KERNEL_SIZES</span><span class="p">,</span>
    <span class="n">dropout_rate</span><span class="o">=</span><span class="n">DROPOUT_RATE</span><span class="p">,</span>
    <span class="n">pretrained_embeddings</span><span class="o">=</span><span class="n">embedding_matrix</span><span class="p">,</span>
    <span class="n">freeze_embeddings</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Modelo creado</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📊 Parametros totales: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Parametros entrenables: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🎯 CONFIGURANDO ENTRENAMIENTO&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="n">class_weights_tensor</span><span class="p">)</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">LEARNING_RATE</span><span class="p">)</span>

<span class="n">scheduler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">(</span>
    <span class="n">optimizer</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Configuracion lista&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Loss: CrossEntropyLoss con class weights&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Optimizer: Adam (lr=</span><span class="si">{</span><span class="n">LEARNING_RATE</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Scheduler: ReduceLROnPlateau</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Training&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">sequences</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">progress_bar</span><span class="p">:</span>
        <span class="n">sequences</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">sequences</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>


        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">sequences</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">progress_bar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span>
            <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;acc&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">correct</span><span class="o">/</span><span class="n">total</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span>
        <span class="p">})</span>

    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="n">total</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>

    <span class="k">return</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">accuracy</span>


<span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">all_preds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_probas</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">sequences</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
            <span class="n">sequences</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">sequences</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">sequences</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">probas</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">probas</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">all_preds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="n">all_labels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="n">all_probas</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">probas</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="n">total</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>
    <span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">all_preds</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
    <span class="n">f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">all_preds</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>

    <span class="n">all_labels_one_hot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)[</span><span class="n">all_labels</span><span class="p">]</span>
    <span class="n">roc_auc_ovr</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">all_labels_one_hot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_probas</span><span class="p">),</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">f1_macro</span><span class="p">,</span> <span class="n">f1_weighted</span><span class="p">,</span> <span class="n">roc_auc_ovr</span><span class="p">,</span> <span class="n">all_preds</span><span class="p">,</span> <span class="n">all_labels</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🚀 INICIANDO ENTRENAMIENTO&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">best_val_roc_auc_ovr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">patience_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">history</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;train_loss&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;train_acc&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;val_loss&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_acc&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_f1_macro&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_f1_weighted&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_roc_auc_ovr&#39;</span><span class="p">:</span> <span class="p">[]</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📍 Epoca </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">EPOCHS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

    <span class="n">train_loss</span><span class="p">,</span> <span class="n">train_acc</span> <span class="o">=</span> <span class="n">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="n">val_loss</span><span class="p">,</span> <span class="n">val_acc</span><span class="p">,</span> <span class="n">val_f1_macro</span><span class="p">,</span> <span class="n">val_f1_weighted</span><span class="p">,</span> <span class="n">val_roc_auc_ovr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">num_classes</span>
    <span class="p">)</span>

    <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>

    <span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
    <span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_acc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_acc</span><span class="p">)</span>
    <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>
    <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_acc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_acc</span><span class="p">)</span>
    <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_f1_macro&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_f1_macro</span><span class="p">)</span>
    <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_f1_weighted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_f1_weighted</span><span class="p">)</span>
    <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_roc_auc_ovr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_roc_auc_ovr</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📊 Resultados:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Train - Loss: </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Acc: </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Val   - Loss: </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Acc: </span><span class="si">{</span><span class="n">val_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1(macro): </span><span class="si">{</span><span class="n">val_f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | F1(weighted): </span><span class="si">{</span><span class="n">val_f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | ROC AUC (OvR): </span><span class="si">{</span><span class="n">val_roc_auc_ovr</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">val_roc_auc_ovr</span> <span class="o">&gt;</span> <span class="n">best_val_roc_auc_ovr</span><span class="p">:</span>
        <span class="n">best_val_roc_auc_ovr</span> <span class="o">=</span> <span class="n">val_roc_auc_ovr</span>
        <span class="n">patience_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s1">&#39;best_cnn_model.pth&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ✅ Mejor modelo guardado (ROC AUC OvR: </span><span class="si">{</span><span class="n">best_val_roc_auc_ovr</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">patience_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ⏳ Patience: </span><span class="si">{</span><span class="n">patience_counter</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">EARLY_STOPPING_PATIENCE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">patience_counter</span> <span class="o">&gt;=</span> <span class="n">EARLY_STOPPING_PATIENCE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">❌ Early stopping activado en epoca </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">break</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ ENTRENAMIENTO COMPLETADO&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📈 Generando graficas...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Loss&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Val Loss&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoca&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_acc&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Acc&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_acc&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Val Acc&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoca&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_f1_macro&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Val F1-Macro&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_f1_weighted&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Val F1-Weighted&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;F1-Score (Validation)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoca&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_roc_auc_ovr&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Val ROC AUC (OvR)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;ROC AUC (Validation)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoca&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ROC AUC&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🧪 EVALUACION EN TEST SET&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;best_cnn_model.pth&#39;</span><span class="p">))</span>

<span class="n">test_loss</span><span class="p">,</span> <span class="n">test_acc</span><span class="p">,</span> <span class="n">test_f1_macro</span><span class="p">,</span> <span class="n">test_f1_weighted</span><span class="p">,</span> <span class="n">test_roc_auc_ovr</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">num_classes</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📊 METRICAS EN TEST SET:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Loss: </span><span class="si">{</span><span class="n">test_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score (macro): </span><span class="si">{</span><span class="n">test_f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score (weighted): </span><span class="si">{</span><span class="n">test_f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ROC AUC (OvR): </span><span class="si">{</span><span class="n">test_roc_auc_ovr</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;REPORTE DE CLASIFICACION DETALLADO&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span>
    <span class="n">y_true</span><span class="p">,</span>
    <span class="n">y_pred</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">),</span>
    <span class="n">target_names</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span>
    <span class="n">digits</span><span class="o">=</span><span class="mi">4</span>
<span class="p">))</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📊 Generando matriz de confusion...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
    <span class="n">cm</span><span class="p">,</span>
    <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span>
    <span class="n">xticklabels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span>
    <span class="n">yticklabels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span>
    <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Numero de predicciones&#39;</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusion - CNN-1D&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Verdadero&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicho&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">💾 Guardando modelo y artefactos...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span>
    <span class="s1">&#39;model_state_dict&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
    <span class="s1">&#39;vocab&#39;</span><span class="p">:</span> <span class="n">vocab</span><span class="p">,</span>
    <span class="s1">&#39;word_to_idx&#39;</span><span class="p">:</span> <span class="n">word_to_idx</span><span class="p">,</span>
    <span class="s1">&#39;label_encoder&#39;</span><span class="p">:</span> <span class="n">label_encoder</span><span class="p">,</span>
    <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;max_seq_length&#39;</span><span class="p">:</span> <span class="n">MAX_SEQUENCE_LENGTH</span><span class="p">,</span>
        <span class="s1">&#39;embedding_dim&#39;</span><span class="p">:</span> <span class="n">EMBEDDING_DIM</span><span class="p">,</span>
        <span class="s1">&#39;num_filters&#39;</span><span class="p">:</span> <span class="n">NUM_FILTERS</span><span class="p">,</span>
        <span class="s1">&#39;kernel_sizes&#39;</span><span class="p">:</span> <span class="n">KERNEL_SIZES</span><span class="p">,</span>
        <span class="s1">&#39;dropout_rate&#39;</span><span class="p">:</span> <span class="n">DROPOUT_RATE</span><span class="p">,</span>
        <span class="s1">&#39;num_classes&#39;</span><span class="p">:</span> <span class="n">num_classes</span><span class="p">,</span>
        <span class="s1">&#39;test_accuracy&#39;</span><span class="p">:</span> <span class="n">test_acc</span><span class="p">,</span>
        <span class="s1">&#39;test_f1_macro&#39;</span><span class="p">:</span> <span class="n">test_f1_macro</span><span class="p">,</span>
        <span class="s1">&#39;test_f1_weighted&#39;</span><span class="p">:</span> <span class="n">test_f1_weighted</span><span class="p">,</span>
        <span class="s1">&#39;test_roc_auc_ovr&#39;</span><span class="p">:</span> <span class="n">test_roc_auc_ovr</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="s1">&#39;cnn_model_complete.pth&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Modelo guardado en: cnn_model_complete.pth&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🎉 PROCESO COMPLETADO&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">27.9/27.9 MB</span> <span class=" -Color -Color-Red">70.9 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25h✅ Imports completados

[INFO] Dispositivo: cuda

======================================================================
📊 PREPARACION DE DATOS PARA CNN-1D
======================================================================


✔ Iniciando pipeline de preparacion de datos para modelos...
   [INFO] Google Drive ya montado.

✔ Intentando cargar dataframe aumentado desde Google Drive: /content/drive/MyDrive/data_augmented_processed.csv
✅ Dataframe aumentado cargado desde Google Drive: 2621 filas, 8 columnas.
   ✓ &#39;text_medium&#39; columna llenada/regenerada para 1 filas.
   ✓ &#39;text_advanced&#39; columna llenada/regenerada para 1 filas.
   ✀ Total de filas afectadas por la regeneracion de columnas: 2 (Detalles: &#39;text_medium&#39; (1 nulls), &#39;text_advanced&#39; (1 nulls))

   ✔ DataFrame actualizado y guardado en Google Drive: /content/drive/MyDrive/data_augmented_processed.csv
✅ Pipeline de preparacion de datos completado.

======================================================
░░ PREPARANDO DATOS (SPLIT, ENCODING, PESOS DE CLASE)
========================================================

Clases detectadas: 24
Mapping de clases: {i: label for i, label in enumerate(label_encoder.classes_)}

░ Dataset: 2621 muestras
   Split: 80% train, 10% val, 10% test

✂️ Dividiendo datos usando Stratified Shuffle Split on unique groups (data leakage prevention and stratification)...
✅ Train: 2104 | Val: 262 | Test: 255

⚖️ Calculando pesos de clase para manejar desbalance...

Pesos por clase (entrenamiento):
  ACCOUNTANT           → peso: 0.933 (n=94)
  ADVOCATE             → peso: 0.933 (n=94)
  AGRICULTURE          → peso: 1.154 (n=76)
  APPAREL              → peso: 1.139 (n=77)
  ARTS                 → peso: 1.056 (n=83)
  AUTOMOBILE           → peso: 1.056 (n=83)
  AVIATION             → peso: 0.943 (n=93)
  BANKING              → peso: 0.953 (n=92)
  BPO                  → peso: 1.538 (n=57)
  BUSINESS-DEVELOPMENT → peso: 0.913 (n=96)
  CHEF                 → peso: 0.933 (n=94)
  CONSTRUCTION         → peso: 0.974 (n=90)
  CONSULTANT           → peso: 0.943 (n=93)
  DESIGNER             → peso: 1.031 (n=85)
  DIGITAL-MEDIA        → peso: 1.139 (n=77)
  ENGINEERING          → peso: 0.933 (n=94)
  FINANCE              → peso: 0.933 (n=94)
  FITNESS              → peso: 0.943 (n=93)
  HEALTHCARE           → peso: 0.953 (n=92)
  HR                   → peso: 0.996 (n=88)
  INFORMATION-TECHNOLOGY → peso: 0.913 (n=96)
  PUBLIC-RELATIONS     → peso: 0.985 (n=89)
  SALES                → peso: 0.953 (n=92)
  TEACHER              → peso: 1.069 (n=82)

========================================================

📝 Tokenizando y construyendo vocabulario...

✅ Vocabulario construido: 32604 palabras
   Palabras mas comunes: [(&#39;state&#39;, 14209), (&#39;company&#39;, 13303), (&#39;city&#39;, 12803), (&#39;management&#39;, 10691), (&#39;name&#39;, 10035), (&#39;customer&#39;, 9812), (&#39;service&#39;, 8198), (&#39;work&#39;, 7472), (&#39;sale&#39;, 7038), (&#39;business&#39;, 6875)]

🔢 Convirtiendo textos a secuencias...

✅ Secuencias creadas
   Shape train: (2104, 500)
   Shape val: (262, 500)
   Shape test: (255, 500)

======================================================================
🎯 CARGANDO EMBEDDINGS PREENTRENADOS
======================================================================

Selecciona embeddings preentrenados:
  1. Word2Vec GoogleNews (300d) - ~1.5GB
  2. GloVe Twitter (200d) - mas rapido
  3. Entrenar Word2Vec localmente (mas rapido, pero menos robusto)

🔄 Entrenando Word2Vec localmente en tus datos...
✅ Embeddings cargados

🏗️  Creando matriz de embeddings para vocabulario...

✅ Matriz de embeddings creada
   Cobertura: 17758/32604 palabras (54.5%)
   Shape: (32604, 300)

✅ DataLoaders creados
   Train batches: 66
   Val batches: 9
   Test batches: 8

======================================================================
🏗️ CONSTRUYENDO MODELO CNN-1D
======================================================================

✅ Modelo creado

TextCNN(
  (embedding): Embedding(32604, 300, padding_idx=0)
  (convs): ModuleList(
    (0): Conv1d(300, 128, kernel_size=(2,), stride=(1,))
    (1): Conv1d(300, 128, kernel_size=(3,), stride=(1,))
    (2): Conv1d(300, 128, kernel_size=(4,), stride=(1,))
    (3): Conv1d(300, 128, kernel_size=(5,), stride=(1,))
  )
  (dropout): Dropout(p=0.5, inplace=False)
  (fc): Linear(in_features=512, out_features=24, bias=True)
)

📊 Parametros totales: 10,331,624
   Parametros entrenables: 10,331,624

======================================================================
🎯 CONFIGURANDO ENTRENAMIENTO
======================================================================

✅ Configuracion lista
   Loss: CrossEntropyLoss con class weights
   Optimizer: Adam (lr=0.001)
   Scheduler: ReduceLROnPlateau

======================================================================
🚀 INICIANDO ENTRENAMIENTO
======================================================================


📍 Epoca 1/20
----------------------------------------------------------------------
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>📊 Resultados:
   Train - Loss: 3.1514 | Acc: 0.1454
   Val   - Loss: 2.1990 | Acc: 0.3931 | F1(macro): 0.3299 | F1(weighted): 0.3424 | ROC AUC (OvR): 0.8843
   ✅ Mejor modelo guardado (ROC AUC OvR: 0.8843)

📍 Epoca 2/20
----------------------------------------------------------------------
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>📊 Resultados:
   Train - Loss: 2.1986 | Acc: 0.3546
   Val   - Loss: 1.7592 | Acc: 0.5038 | F1(macro): 0.4582 | F1(weighted): 0.4742 | ROC AUC (OvR): 0.9186
   ✅ Mejor modelo guardado (ROC AUC OvR: 0.9186)

📍 Epoca 3/20
----------------------------------------------------------------------
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>📊 Resultados:
   Train - Loss: 1.6909 | Acc: 0.5038
   Val   - Loss: 1.6207 | Acc: 0.5076 | F1(macro): 0.4575 | F1(weighted): 0.4739 | ROC AUC (OvR): 0.9317
   ✅ Mejor modelo guardado (ROC AUC OvR: 0.9317)

📍 Epoca 4/20
----------------------------------------------------------------------
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>📊 Resultados:
   Train - Loss: 1.3706 | Acc: 0.5841
   Val   - Loss: 1.4970 | Acc: 0.5878 | F1(macro): 0.5180 | F1(weighted): 0.5372 | ROC AUC (OvR): 0.9429
   ✅ Mejor modelo guardado (ROC AUC OvR: 0.9429)

📍 Epoca 5/20
----------------------------------------------------------------------
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>📊 Resultados:
   Train - Loss: 1.0558 | Acc: 0.6906
   Val   - Loss: 1.2596 | Acc: 0.6412 | F1(macro): 0.5874 | F1(weighted): 0.6111 | ROC AUC (OvR): 0.9519
   ✅ Mejor modelo guardado (ROC AUC OvR: 0.9519)

📍 Epoca 6/20
----------------------------------------------------------------------
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>📊 Resultados:
   Train - Loss: 0.8261 | Acc: 0.7538
   Val   - Loss: 1.2282 | Acc: 0.6565 | F1(macro): 0.5972 | F1(weighted): 0.6217 | ROC AUC (OvR): 0.9564
   ✅ Mejor modelo guardado (ROC AUC OvR: 0.9564)

📍 Epoca 7/20
----------------------------------------------------------------------
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>📊 Resultados:
   Train - Loss: 0.6276 | Acc: 0.8194
   Val   - Loss: 1.1097 | Acc: 0.6908 | F1(macro): 0.6272 | F1(weighted): 0.6535 | ROC AUC (OvR): 0.9628
   ✅ Mejor modelo guardado (ROC AUC OvR: 0.9628)

📍 Epoca 8/20
----------------------------------------------------------------------
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>📊 Resultados:
   Train - Loss: 0.5344 | Acc: 0.8398
   Val   - Loss: 1.0616 | Acc: 0.7061 | F1(macro): 0.6517 | F1(weighted): 0.6796 | ROC AUC (OvR): 0.9696
   ✅ Mejor modelo guardado (ROC AUC OvR: 0.9696)

📍 Epoca 9/20
----------------------------------------------------------------------
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>📊 Resultados:
   Train - Loss: 0.4028 | Acc: 0.8878
   Val   - Loss: 1.0320 | Acc: 0.7366 | F1(macro): 0.6818 | F1(weighted): 0.7088 | ROC AUC (OvR): 0.9699
   ✅ Mejor modelo guardado (ROC AUC OvR: 0.9699)

📍 Epoca 10/20
----------------------------------------------------------------------
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>📊 Resultados:
   Train - Loss: 0.3011 | Acc: 0.9140
   Val   - Loss: 1.0176 | Acc: 0.7061 | F1(macro): 0.6494 | F1(weighted): 0.6779 | ROC AUC (OvR): 0.9721
   ✅ Mejor modelo guardado (ROC AUC OvR: 0.9721)

📍 Epoca 11/20
----------------------------------------------------------------------
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>📊 Resultados:
   Train - Loss: 0.2286 | Acc: 0.9463
   Val   - Loss: 1.0252 | Acc: 0.7176 | F1(macro): 0.6667 | F1(weighted): 0.6953 | ROC AUC (OvR): 0.9658
   ⏳ Patience: 1/3

📍 Epoca 12/20
----------------------------------------------------------------------
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>📊 Resultados:
   Train - Loss: 0.1792 | Acc: 0.9582
   Val   - Loss: 0.9808 | Acc: 0.7519 | F1(macro): 0.6990 | F1(weighted): 0.7281 | ROC AUC (OvR): 0.9681
   ⏳ Patience: 2/3

📍 Epoca 13/20
----------------------------------------------------------------------
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>📊 Resultados:
   Train - Loss: 0.1438 | Acc: 0.9686
   Val   - Loss: 1.0040 | Acc: 0.7405 | F1(macro): 0.6870 | F1(weighted): 0.7155 | ROC AUC (OvR): 0.9677
   ⏳ Patience: 3/3

❌ Early stopping activado en epoca 13

======================================================================
✅ ENTRENAMIENTO COMPLETADO
======================================================================

📈 Generando graficas...
</pre></div>
</div>
<img alt="_images/16fcc5147448ffa265f3c47a80936b370c575882d3439f35602a6219f2e658a4.png" src="_images/16fcc5147448ffa265f3c47a80936b370c575882d3439f35602a6219f2e658a4.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>======================================================================
🧪 EVALUACION EN TEST SET
======================================================================

📊 METRICAS EN TEST SET:
   Loss: 1.0542
   Accuracy: 0.7333
   F1-Score (macro): 0.6716
   F1-Score (weighted): 0.7112
   ROC AUC (OvR): 0.9633

======================================================================
REPORTE DE CLASIFICACION DETALLADO
======================================================================

                        precision    recall  f1-score   support

            ACCOUNTANT     0.9000    0.7500    0.8182        12
              ADVOCATE     0.6923    0.7500    0.7200        12
           AGRICULTURE     1.0000    0.6667    0.8000         9
               APPAREL     0.5000    0.1000    0.1667        10
                  ARTS     0.6364    0.7000    0.6667        10
            AUTOMOBILE     0.0000    0.0000    0.0000         5
              AVIATION     0.7273    0.6667    0.6957        12
               BANKING     0.7000    0.6364    0.6667        11
                   BPO     0.0000    0.0000    0.0000         4
  BUSINESS-DEVELOPMENT     0.7059    1.0000    0.8276        12
                  CHEF     1.0000    0.7500    0.8571        12
          CONSTRUCTION     0.9091    0.9091    0.9091        11
            CONSULTANT     0.3077    0.3636    0.3333        11
              DESIGNER     0.7857    1.0000    0.8800        11
         DIGITAL-MEDIA     0.6000    0.9000    0.7200        10
           ENGINEERING     0.9000    0.7500    0.8182        12
               FINANCE     0.7333    0.9167    0.8148        12
               FITNESS     0.7500    0.7500    0.7500        12
            HEALTHCARE     0.6364    0.6364    0.6364        11
                    HR     0.8462    1.0000    0.9167        11
INFORMATION-TECHNOLOGY     0.8571    1.0000    0.9231        12
      PUBLIC-RELATIONS     0.6667    0.7273    0.6957        11
                 SALES     0.6667    0.8333    0.7407        12
               TEACHER     0.7273    0.8000    0.7619        10

              accuracy                         0.7333       255
             macro avg     0.6770    0.6919    0.6716       255
          weighted avg     0.7145    0.7333    0.7112       255


📊 Generando matriz de confusion...
</pre></div>
</div>
<img alt="_images/311d3722075a4fb3086fcf85bc898e6f73a4ce5fb927a01a6dec6a13143f3a0f.png" src="_images/311d3722075a4fb3086fcf85bc898e6f73a4ce5fb927a01a6dec6a13143f3a0f.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>💾 Guardando modelo y artefactos...

✅ Modelo guardado en: cnn_model_complete.pth

======================================================================
🎉 PROCESO COMPLETADO
======================================================================
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title bilstm</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">gensim</span> <span class="n">torch</span> <span class="n">scikit</span><span class="o">-</span><span class="n">learn</span> <span class="n">matplotlib</span> <span class="n">seaborn</span> <span class="o">-</span><span class="n">q</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;WANDB_DISABLED&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">roc_auc_score</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">gensim.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Word2Vec</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Imports completados</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="n">VOCAB_SIZE</span> <span class="o">=</span> <span class="mi">50000</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;▥̲░▥̲  Dispositivo: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;lstm_units&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">],</span>
    <span class="s1">&#39;num_lstm_layers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="s1">&#39;dropout_rate&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="mf">0.6</span><span class="p">,</span><span class="mf">0.8</span><span class="p">],</span>
    <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">],</span>
    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">],</span>
    <span class="s1">&#39;sequence_length&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">700</span><span class="p">],</span>
    <span class="s1">&#39;epochs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span>
    <span class="s1">&#39;embedding_dim&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
<span class="p">}</span>


<span class="n">N_COMBINATIONS</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">EARLY_STOPPING_PATIENCE</span> <span class="o">=</span> <span class="mi">5</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📊 Espacio de hiperparámetros:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">param_grid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">param</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total combinaciones posibles: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">param_grid</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combinaciones a probar: </span><span class="si">{</span><span class="n">N_COMBINATIONS</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📊 PREPARACIÓN DE DATOS PARA WORD2VEC + BiLSTM&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">data_for_models</span><span class="p">,</span> <span class="n">original_ids_for_models</span> <span class="o">=</span> <span class="n">get_data_for_models</span><span class="p">()</span>

<span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span>
 <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
 <span class="n">label_encoder</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span>
 <span class="n">class_weights_numpy</span><span class="p">,</span> <span class="n">class_weights_tensor</span><span class="p">,</span>
 <span class="n">sample_weights_train</span><span class="p">)</span> <span class="o">=</span> <span class="n">prepare_data_for_training</span><span class="p">(</span>
    <span class="n">data_for_models</span><span class="p">,</span> <span class="s2">&quot;text_advanced&quot;</span><span class="p">,</span> <span class="s2">&quot;Category&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">group_ids</span><span class="o">=</span><span class="n">original_ids_for_models</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shapes after preparation: X_train=</span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, X_val=</span><span class="si">{</span><span class="n">X_val</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, X_test=</span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;─░ Tokenizando y construyendo vocabulario...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="n">train_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">X_train</span><span class="p">]</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>

<span class="n">word_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
<span class="k">for</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">train_tokens</span><span class="p">:</span>
    <span class="n">word_counts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

<span class="n">vocab</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;PAD&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;UNK&gt;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">word_counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="n">VOCAB_SIZE</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)]</span>
<span class="n">word_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vocab</span><span class="p">)}</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Vocabulario construido: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span><span class="si">}</span><span class="s2"> palabras&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Palabras mas comunes: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">word_counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;|▒ ENTRENAMIENTO WORD2VEC LOCAL&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ℐ Entrenando modelo Word2Vec...&quot;</span><span class="p">)</span>

<span class="n">MAX_EMBEDDING_DIM</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;embedding_dim&#39;</span><span class="p">])</span>

<span class="n">word2vec_model</span> <span class="o">=</span> <span class="n">Word2Vec</span><span class="p">(</span>
    <span class="n">sentences</span><span class="o">=</span><span class="n">train_tokens</span><span class="p">,</span>
    <span class="n">vector_size</span><span class="o">=</span><span class="n">MAX_EMBEDDING_DIM</span><span class="p">,</span>
    <span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">min_count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">sg</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Word2Vec entrenado&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Vocabulario Word2Vec: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">word2vec_model</span><span class="o">.</span><span class="n">wv</span><span class="p">)</span><span class="si">}</span><span class="s2"> palabras&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Dimensión: </span><span class="si">{</span><span class="n">MAX_EMBEDDING_DIM</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_embedding_matrix</span><span class="p">(</span><span class="n">word_to_idx</span><span class="p">,</span> <span class="n">word2vec_model</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Crea matriz de embeddings desde Word2Vec.&quot;&quot;&quot;</span>
    <span class="n">embedding_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">word_to_idx</span><span class="p">),</span> <span class="n">embedding_dim</span><span class="p">))</span>
    <span class="n">found_words</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">word_to_idx</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&lt;PAD&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;UNK&gt;&#39;</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">w2v_vector</span> <span class="o">=</span> <span class="n">word2vec_model</span><span class="o">.</span><span class="n">wv</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w2v_vector</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">embedding_dim</span><span class="p">:</span>
                <span class="n">embedding_matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">w2v_vector</span><span class="p">[:</span><span class="n">embedding_dim</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">embedding_matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">w2v_vector</span><span class="p">)]</span> <span class="o">=</span> <span class="n">w2v_vector</span>
            <span class="n">found_words</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">embedding_matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">embedding_dim</span><span class="p">,))</span>

    <span class="n">coverage</span> <span class="o">=</span> <span class="n">found_words</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_to_idx</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="k">return</span> <span class="n">embedding_matrix</span><span class="p">,</span> <span class="n">coverage</span>


<span class="k">def</span><span class="w"> </span><span class="nf">text_to_sequence</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">max_length</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convierte texto a secuencia de indices.&quot;&quot;&quot;</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="p">[</span><span class="n">word_to_idx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">[</span><span class="s1">&#39;&lt;UNK&gt;&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_length</span><span class="p">:</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span> <span class="o">+</span> <span class="p">[</span><span class="n">word_to_idx</span><span class="p">[</span><span class="s1">&#39;&lt;PAD&gt;&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">[:</span><span class="n">max_length</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">sequence</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_sequences</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">max_length</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Crea secuencias para un conjunto de textos.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">text_to_sequence</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">max_length</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">])</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TextDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequences</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">BiLSTMClassifier</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">lstm_units</span><span class="p">,</span> <span class="n">num_lstm_layers</span><span class="p">,</span>
                 <span class="n">num_classes</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="p">,</span> <span class="n">pretrained_embeddings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BiLSTMClassifier</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">padding_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pretrained_embeddings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">pretrained_embeddings</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span>
            <span class="n">embedding_dim</span><span class="p">,</span>
            <span class="n">lstm_units</span><span class="p">,</span>
            <span class="n">num_layers</span><span class="o">=</span><span class="n">num_lstm_layers</span><span class="p">,</span>
            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">bidirectional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dropout</span><span class="o">=</span><span class="n">dropout_rate</span> <span class="k">if</span> <span class="n">num_lstm_layers</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">lstm_units</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">embedded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">lstm_out</span><span class="p">,</span> <span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">embedded</span><span class="p">)</span>

        <span class="n">hidden_concat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">hidden</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">hidden</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

        <span class="n">dropped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">hidden_concat</span><span class="p">)</span>

        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">dropped</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">logits</span>


<span class="k">def</span><span class="w"> </span><span class="nf">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">sequences</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
        <span class="n">sequences</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">sequences</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">sequences</span><span class="p">);</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">);</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>
    <span class="k">return</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">accuracy</span>


<span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">all_preds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_probas</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">sequences</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
            <span class="n">sequences</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">sequences</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">sequences</span><span class="p">);</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">);</span>

            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="n">probas</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">probas</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">all_preds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="n">all_labels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="n">all_probas</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">probas</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>
    <span class="n">f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">all_preds</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
    <span class="n">f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">all_preds</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>

    <span class="n">all_labels_one_hot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)[</span><span class="n">all_labels</span><span class="p">]</span>
    <span class="n">roc_auc_ovr</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">all_labels_one_hot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_probas</span><span class="p">),</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">f1_macro</span><span class="p">,</span> <span class="n">f1_weighted</span><span class="p">,</span> <span class="n">roc_auc_ovr</span><span class="p">,</span> <span class="n">all_preds</span><span class="p">,</span> <span class="n">all_labels</span>


<span class="k">def</span><span class="w"> </span><span class="nf">train_model_with_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span>
                            <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">word2vec_model</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span>
                            <span class="n">class_weights_tensor</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Entrena un modelo con parámetros específicos.&quot;&quot;&quot;</span>

    <span class="n">embedding_matrix</span><span class="p">,</span> <span class="n">coverage</span> <span class="o">=</span> <span class="n">create_embedding_matrix</span><span class="p">(</span>
        <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">word2vec_model</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;embedding_dim&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">X_train_seq</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;sequence_length&#39;</span><span class="p">])</span>
    <span class="n">X_val_seq</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;sequence_length&#39;</span><span class="p">])</span>

    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">TextDataset</span><span class="p">(</span><span class="n">X_train_seq</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">TextDataset</span><span class="p">(</span><span class="n">X_val_seq</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>

    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">BiLSTMClassifier</span><span class="p">(</span>
        <span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">word_to_idx</span><span class="p">),</span>
        <span class="n">embedding_dim</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;embedding_dim&#39;</span><span class="p">],</span>
        <span class="n">lstm_units</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lstm_units&#39;</span><span class="p">],</span>
        <span class="n">num_lstm_layers</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;num_lstm_layers&#39;</span><span class="p">],</span>
        <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span>
        <span class="n">dropout_rate</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;dropout_rate&#39;</span><span class="p">],</span>
        <span class="n">pretrained_embeddings</span><span class="o">=</span><span class="n">embedding_matrix</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="n">class_weights_tensor</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">])</span>

    <span class="n">best_val_roc_auc_ovr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">patience_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]):</span>
        <span class="n">train_loss</span><span class="p">,</span> <span class="n">train_acc</span> <span class="o">=</span> <span class="n">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="n">val_loss</span><span class="p">,</span> <span class="n">val_acc</span><span class="p">,</span> <span class="n">val_f1_macro</span><span class="p">,</span> <span class="n">val_f1_weighted</span><span class="p">,</span> <span class="n">val_roc_auc_ovr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">num_classes</span>
        <span class="p">)</span>

        <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;train_loss&#39;</span><span class="p">:</span> <span class="n">train_loss</span><span class="p">,</span>
            <span class="s1">&#39;train_acc&#39;</span><span class="p">:</span> <span class="n">train_acc</span><span class="p">,</span>
            <span class="s1">&#39;val_loss&#39;</span><span class="p">:</span> <span class="n">val_loss</span><span class="p">,</span>
            <span class="s1">&#39;val_acc&#39;</span><span class="p">:</span> <span class="n">val_acc</span><span class="p">,</span>
            <span class="s1">&#39;val_f1_macro&#39;</span><span class="p">:</span> <span class="n">val_f1_macro</span><span class="p">,</span>
            <span class="s1">&#39;val_f1_weighted&#39;</span><span class="p">:</span> <span class="n">val_f1_weighted</span><span class="p">,</span>
            <span class="s1">&#39;val_roc_auc_ovr&#39;</span><span class="p">:</span> <span class="n">val_roc_auc_ovr</span>
        <span class="p">})</span>

        <span class="k">if</span> <span class="n">val_roc_auc_ovr</span> <span class="o">&gt;</span> <span class="n">best_val_roc_auc_ovr</span><span class="p">:</span>
            <span class="n">best_val_roc_auc_ovr</span> <span class="o">=</span> <span class="n">val_roc_auc_ovr</span>
            <span class="n">patience_counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">best_model_state</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">patience_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">patience_counter</span> <span class="o">&gt;=</span> <span class="n">EARLY_STOPPING_PATIENCE</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">best_model_state</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">best_val_roc_auc_ovr</span><span class="p">,</span> <span class="n">history</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✤ RANDOM SEARCH - HYPERPARAMETER TUNING&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_COMBINATIONS</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ℐ Iteración </span><span class="si">{</span><span class="n">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">N_COMBINATIONS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;lstm_units&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;lstm_units&#39;</span><span class="p">])),</span>
        <span class="s1">&#39;num_lstm_layers&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;num_lstm_layers&#39;</span><span class="p">])),</span>
        <span class="s1">&#39;dropout_rate&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;dropout_rate&#39;</span><span class="p">])),</span>
        <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">])),</span>
        <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])),</span>
        <span class="s1">&#39;sequence_length&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;sequence_length&#39;</span><span class="p">])),</span>
        <span class="s1">&#39;epochs&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">])),</span>
        <span class="s1">&#39;embedding_dim&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;embedding_dim&#39;</span><span class="p">]))</span>
    <span class="p">}</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Parámetros:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">best_roc_auc_ovr</span><span class="p">,</span> <span class="n">history</span> <span class="o">=</span> <span class="n">train_model_with_params</span><span class="p">(</span>
            <span class="n">params</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span>
            <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">word2vec_model</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span>
            <span class="n">class_weights_tensor</span><span class="p">,</span> <span class="n">device</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">✅ Mejor ROC AUC (val): </span><span class="si">{</span><span class="n">best_roc_auc_ovr</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Épocas entrenadas: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;iteration&#39;</span><span class="p">:</span> <span class="n">iteration</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="s1">&#39;best_val_roc_auc_ovr&#39;</span><span class="p">:</span> <span class="n">best_roc_auc_ovr</span><span class="p">,</span>
            <span class="s1">&#39;epochs_trained&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">),</span>
            <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="n">history</span><span class="p">,</span>
            <span class="s1">&#39;model_state&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="p">})</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">❌ Error en iteración </span><span class="si">{</span><span class="n">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">continue</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📊 RESUMEN DE BÚSEDA&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">all_results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;best_val_roc_auc_ovr&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅▒ Top 5 configuraciones:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_results</span><span class="p">[:</span><span class="mi">5</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. ROC AUC: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;best_val_roc_auc_ovr&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">key</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

<span class="n">best_result</span> <span class="o">=</span> <span class="n">all_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">best_params</span> <span class="o">=</span> <span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
<span class="n">best_roc_auc_ovr</span> <span class="o">=</span> <span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;best_val_roc_auc_ovr&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ MEJORES HIPERPARÁMETROS:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">best_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⌶̲⌶̲⌶̲⌶̲⌶̲⌶̲⌶̲ Mejor ROC AUC (validation): </span><span class="si">{</span><span class="n">best_roc_auc_ovr</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✂▒ EVALUACIÓN FINAL EN TEST SET&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ℐ Recreando mejor modelo y evaluando en test...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">embedding_matrix</span><span class="p">,</span> <span class="n">coverage</span> <span class="o">=</span> <span class="n">create_embedding_matrix</span><span class="p">(</span>
    <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">word2vec_model</span><span class="p">,</span> <span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;embedding_dim&#39;</span><span class="p">]</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Embedding matrix: cobertura </span><span class="si">{</span><span class="n">coverage</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">X_test_seq</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">word_to_idx</span><span class="p">,</span> <span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;sequence_length&#39;</span><span class="p">])</span>

<span class="n">best_model</span> <span class="o">=</span> <span class="n">BiLSTMClassifier</span><span class="p">(</span>
    <span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">word_to_idx</span><span class="p">),</span>
    <span class="n">embedding_dim</span><span class="o">=</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;embedding_dim&#39;</span><span class="p">],</span>
    <span class="n">lstm_units</span><span class="o">=</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;lstm_units&#39;</span><span class="p">],</span>
    <span class="n">num_lstm_layers</span><span class="o">=</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;num_lstm_layers&#39;</span><span class="p">],</span>
    <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span>
    <span class="n">dropout_rate</span><span class="o">=</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;dropout_rate&#39;</span><span class="p">],</span>
    <span class="n">pretrained_embeddings</span><span class="o">=</span><span class="n">embedding_matrix</span>
<span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">best_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;model_state&#39;</span><span class="p">])</span>

<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">TextDataset</span><span class="p">(</span><span class="n">X_test_seq</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">best_params</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="n">class_weights_tensor</span><span class="p">)</span>
<span class="n">test_loss</span><span class="p">,</span> <span class="n">test_acc</span><span class="p">,</span> <span class="n">test_f1_macro</span><span class="p">,</span> <span class="n">test_f1_weighted</span><span class="p">,</span> <span class="n">test_roc_auc_ovr</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span>
    <span class="n">best_model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">num_classes</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📊 MÉTRICAS EN TEST SET:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Loss: </span><span class="si">{</span><span class="n">test_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy: </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score (macro): </span><span class="si">{</span><span class="n">test_f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-Score (weighted): </span><span class="si">{</span><span class="n">test_f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ROC AUC (OvR): </span><span class="si">{</span><span class="n">test_roc_auc_ovr</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;REPORTE DE CLASIFICACIÓN DETALLADO&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📊 Generando matriz de confusión...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
    <span class="n">cm</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span>
    <span class="n">xticklabels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span>
    <span class="n">yticklabels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span>
    <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Número de predicciones&#39;</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - Word2Vec + BiLSTM (Tuned)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Verdadero&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicho&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">↗▒ Generando gráficas de entrenamiento...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">history_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_df</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">],</span> <span class="n">history_df</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Loss&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_df</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">],</span> <span class="n">history_df</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Val Loss&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Época&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_df</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">],</span> <span class="n">history_df</span><span class="p">[</span><span class="s1">&#39;train_acc&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Acc&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_df</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">],</span> <span class="n">history_df</span><span class="p">[</span><span class="s1">&#39;val_acc&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Val Acc&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Época&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_df</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">],</span> <span class="n">history_df</span><span class="p">[</span><span class="s1">&#39;val_f1_macro&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Val F1-Macro&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_df</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">],</span> <span class="n">history_df</span><span class="p">[</span><span class="s1">&#39;val_f1_weighted&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Val F1-Weighted&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;F1-Score (Validation)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Época&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;F1-Score&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_df</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">],</span> <span class="n">history_df</span><span class="p">[</span><span class="s1">&#39;val_roc_auc_ovr&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Val ROC AUC (OvR)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;ROC AUC (Validation)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Época&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ROC AUC&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">|▒ Guardando modelo y artefactos...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span>
    <span class="s1">&#39;model_state_dict&#39;</span><span class="p">:</span> <span class="n">best_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
    <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">best_params</span><span class="p">,</span>
    <span class="s1">&#39;vocab&#39;</span><span class="p">:</span> <span class="n">vocab</span><span class="p">,</span>
    <span class="s1">&#39;word_to_idx&#39;</span><span class="p">:</span> <span class="n">word_to_idx</span><span class="p">,</span>
    <span class="s1">&#39;label_encoder&#39;</span><span class="p">:</span> <span class="n">label_encoder</span><span class="p">,</span>
    <span class="s1">&#39;embedding_matrix&#39;</span><span class="p">:</span> <span class="n">embedding_matrix</span><span class="p">,</span>
    <span class="s1">&#39;num_classes&#39;</span><span class="p">:</span> <span class="n">num_classes</span><span class="p">,</span>
    <span class="s1">&#39;test_roc_auc_ovr&#39;</span><span class="p">:</span> <span class="n">test_roc_auc_ovr</span>
<span class="p">},</span> <span class="s1">&#39;bilstm_model_best.pth&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Modelo guardado en: bilstm_model_best.pth&quot;</span><span class="p">)</span>

<span class="n">word2vec_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;word2vec_model.bin&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Word2Vec guardado: word22vec_model.bin&quot;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="n">results_summary</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;best_params&#39;</span><span class="p">:</span> <span class="n">best_params</span><span class="p">,</span>
    <span class="s1">&#39;best_val_roc_auc_ovr&#39;</span><span class="p">:</span> <span class="n">best_roc_auc_ovr</span><span class="p">,</span>
    <span class="s1">&#39;test_metrics&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">test_acc</span><span class="p">,</span>
        <span class="s1">&#39;f1_macro&#39;</span><span class="p">:</span> <span class="n">test_f1_macro</span><span class="p">,</span>
        <span class="s1">&#39;f1_weighted&#39;</span><span class="p">:</span> <span class="n">test_f1_weighted</span><span class="p">,</span>
        <span class="s1">&#39;roc_auc_ovr&#39;</span><span class="p">:</span> <span class="n">test_roc_auc_ovr</span>
    <span class="p">},</span>
    <span class="s1">&#39;all_results&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;iteration&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;iteration&#39;</span><span class="p">],</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">],</span>
            <span class="s1">&#39;best_val_roc_auc_ovr&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;best_val_roc_auc_ovr&#39;</span><span class="p">],</span>
            <span class="s1">&#39;epochs_trained&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;epochs_trained&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">all_results</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;bilstm_search_results.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">results_summary</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Resultados guardados: bilstm_search_results.json&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✨▒ PROCESO COMPLETADO - WORD2VEC + BiLSTM CON TUNING&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Imports completados

▥̲░▥̲  Dispositivo: cuda

📊 Espacio de hiperparámetros:
  lstm_units          : [32, 64]
  num_lstm_layers     : [1, 2]
  dropout_rate        : [0.6, 0.8]
  learning_rate       : [0.001, 0.002]
  batch_size          : [32, 64]
  sequence_length     : [700]
  epochs              : [15, 30]
  embedding_dim       : [50, 100]

Total combinaciones posibles: 128
Combinaciones a probar: 20

======================================================================
📊 PREPARACIÓN DE DATOS PARA WORD2VEC + BiLSTM
======================================================================


✔ Iniciando pipeline de preparacion de datos para modelos...
   [INFO] Google Drive ya montado.

✔ Intentando cargar dataframe aumentado desde Google Drive: /content/drive/MyDrive/data_augmented_processed.csv
✅ Dataframe aumentado cargado desde Google Drive: 2621 filas, 8 columnas.
   ✓ &#39;text_medium&#39; columna llenada/regenerada para 1 filas.
   ✓ &#39;text_advanced&#39; columna llenada/regenerada para 1 filas.
   ✀ Total de filas afectadas por la regeneracion de columnas: 2 (Detalles: &#39;text_medium&#39; (1 nulls), &#39;text_advanced&#39; (1 nulls))

   ✔ DataFrame actualizado y guardado en Google Drive: /content/drive/MyDrive/data_augmented_processed.csv
✅ Pipeline de preparacion de datos completado.

======================================================
░░ PREPARANDO DATOS (SPLIT, ENCODING, PESOS DE CLASE)
========================================================

Clases detectadas: 24
Mapping de clases: {i: label for i, label in enumerate(label_encoder.classes_)}

░ Dataset: 2621 muestras
   Split: 80% train, 10% val, 10% test

✂️ Dividiendo datos usando Stratified Shuffle Split on unique groups (data leakage prevention and stratification)...
✅ Train: 2104 | Val: 262 | Test: 255

⚖️ Calculando pesos de clase para manejar desbalance...

Pesos por clase (entrenamiento):
  ACCOUNTANT           → peso: 0.933 (n=94)
  ADVOCATE             → peso: 0.933 (n=94)
  AGRICULTURE          → peso: 1.154 (n=76)
  APPAREL              → peso: 1.139 (n=77)
  ARTS                 → peso: 1.056 (n=83)
  AUTOMOBILE           → peso: 1.056 (n=83)
  AVIATION             → peso: 0.943 (n=93)
  BANKING              → peso: 0.953 (n=92)
  BPO                  → peso: 1.538 (n=57)
  BUSINESS-DEVELOPMENT → peso: 0.913 (n=96)
  CHEF                 → peso: 0.933 (n=94)
  CONSTRUCTION         → peso: 0.974 (n=90)
  CONSULTANT           → peso: 0.943 (n=93)
  DESIGNER             → peso: 1.031 (n=85)
  DIGITAL-MEDIA        → peso: 1.139 (n=77)
  ENGINEERING          → peso: 0.933 (n=94)
  FINANCE              → peso: 0.933 (n=94)
  FITNESS              → peso: 0.943 (n=93)
  HEALTHCARE           → peso: 0.953 (n=92)
  HR                   → peso: 0.996 (n=88)
  INFORMATION-TECHNOLOGY → peso: 0.913 (n=96)
  PUBLIC-RELATIONS     → peso: 0.985 (n=89)
  SALES                → peso: 0.953 (n=92)
  TEACHER              → peso: 1.069 (n=82)

========================================================

Shapes after preparation: X_train=(2104,), X_val=(262,), X_test=(255,)
─░ Tokenizando y construyendo vocabulario...

✅ Vocabulario construido: 32604 palabras
   Palabras mas comunes: [(&#39;state&#39;, 14209), (&#39;company&#39;, 13303), (&#39;city&#39;, 12803), (&#39;management&#39;, 10691), (&#39;name&#39;, 10035), (&#39;customer&#39;, 9812), (&#39;service&#39;, 8198), (&#39;work&#39;, 7472), (&#39;sale&#39;, 7038), (&#39;business&#39;, 6875)]

======================================================================
|▒ ENTRENAMIENTO WORD2VEC LOCAL
======================================================================

ℐ Entrenando modelo Word2Vec...
✅ Word2Vec entrenado
   Vocabulario Word2Vec: 17758 palabras
   Dimensión: 100

======================================================================
✤ RANDOM SEARCH - HYPERPARAMETER TUNING
======================================================================


======================================================================
ℐ Iteración 1/20
======================================================================

Parámetros:
  lstm_units           = 32
  num_lstm_layers      = 2
  dropout_rate         = 0.6
  learning_rate        = 0.001
  batch_size           = 32
  sequence_length      = 700
  epochs               = 30
  embedding_dim        = 50


✅ Mejor ROC AUC (val): 0.9375
   Épocas entrenadas: 22

======================================================================
ℐ Iteración 2/20
======================================================================

Parámetros:
  lstm_units           = 64
  num_lstm_layers      = 1
  dropout_rate         = 0.8
  learning_rate        = 0.002
  batch_size           = 32
  sequence_length      = 700
  epochs               = 15
  embedding_dim        = 50


✅ Mejor ROC AUC (val): 0.9475
   Épocas entrenadas: 12

======================================================================
ℐ Iteración 3/20
======================================================================

Parámetros:
  lstm_units           = 64
  num_lstm_layers      = 2
  dropout_rate         = 0.6
  learning_rate        = 0.002
  batch_size           = 32
  sequence_length      = 700
  epochs               = 30
  embedding_dim        = 100


✅ Mejor ROC AUC (val): 0.9480
   Épocas entrenadas: 17

======================================================================
ℐ Iteración 4/20
======================================================================

Parámetros:
  lstm_units           = 64
  num_lstm_layers      = 1
  dropout_rate         = 0.6
  learning_rate        = 0.002
  batch_size           = 64
  sequence_length      = 700
  epochs               = 30
  embedding_dim        = 100


✅ Mejor ROC AUC (val): 0.9499
   Épocas entrenadas: 11

======================================================================
ℐ Iteración 5/20
======================================================================

Parámetros:
  lstm_units           = 64
  num_lstm_layers      = 1
  dropout_rate         = 0.8
  learning_rate        = 0.001
  batch_size           = 64
  sequence_length      = 700
  epochs               = 15
  embedding_dim        = 50


✅ Mejor ROC AUC (val): 0.9368
   Épocas entrenadas: 15

======================================================================
ℐ Iteración 6/20
======================================================================

Parámetros:
  lstm_units           = 32
  num_lstm_layers      = 1
  dropout_rate         = 0.8
  learning_rate        = 0.002
  batch_size           = 64
  sequence_length      = 700
  epochs               = 30
  embedding_dim        = 50


✅ Mejor ROC AUC (val): 0.9186
   Épocas entrenadas: 14

======================================================================
ℐ Iteración 7/20
======================================================================

Parámetros:
  lstm_units           = 32
  num_lstm_layers      = 2
  dropout_rate         = 0.8
  learning_rate        = 0.002
  batch_size           = 32
  sequence_length      = 700
  epochs               = 15
  embedding_dim        = 100


✅ Mejor ROC AUC (val): 0.9237
   Épocas entrenadas: 13

======================================================================
ℐ Iteración 8/20
======================================================================

Parámetros:
  lstm_units           = 32
  num_lstm_layers      = 1
  dropout_rate         = 0.8
  learning_rate        = 0.002
  batch_size           = 64
  sequence_length      = 700
  epochs               = 30
  embedding_dim        = 50


✅ Mejor ROC AUC (val): 0.9257
   Épocas entrenadas: 17

======================================================================
ℐ Iteración 9/20
======================================================================

Parámetros:
  lstm_units           = 32
  num_lstm_layers      = 1
  dropout_rate         = 0.8
  learning_rate        = 0.002
  batch_size           = 32
  sequence_length      = 700
  epochs               = 15
  embedding_dim        = 50


✅ Mejor ROC AUC (val): 0.9413
   Épocas entrenadas: 15

======================================================================
ℐ Iteración 10/20
======================================================================

Parámetros:
  lstm_units           = 32
  num_lstm_layers      = 2
  dropout_rate         = 0.6
  learning_rate        = 0.002
  batch_size           = 32
  sequence_length      = 700
  epochs               = 30
  embedding_dim        = 100


✅ Mejor ROC AUC (val): 0.9437
   Épocas entrenadas: 15

======================================================================
ℐ Iteración 11/20
======================================================================

Parámetros:
  lstm_units           = 64
  num_lstm_layers      = 1
  dropout_rate         = 0.6
  learning_rate        = 0.001
  batch_size           = 64
  sequence_length      = 700
  epochs               = 30
  embedding_dim        = 100


✅ Mejor ROC AUC (val): 0.9435
   Épocas entrenadas: 15

======================================================================
ℐ Iteración 12/20
======================================================================

Parámetros:
  lstm_units           = 64
  num_lstm_layers      = 1
  dropout_rate         = 0.8
  learning_rate        = 0.002
  batch_size           = 64
  sequence_length      = 700
  epochs               = 30
  embedding_dim        = 100


✅ Mejor ROC AUC (val): 0.9480
   Épocas entrenadas: 14

======================================================================
ℐ Iteración 13/20
======================================================================

Parámetros:
  lstm_units           = 64
  num_lstm_layers      = 1
  dropout_rate         = 0.6
  learning_rate        = 0.001
  batch_size           = 64
  sequence_length      = 700
  epochs               = 30
  embedding_dim        = 100


✅ Mejor ROC AUC (val): 0.9512
   Épocas entrenadas: 17

======================================================================
ℐ Iteración 14/20
======================================================================

Parámetros:
  lstm_units           = 64
  num_lstm_layers      = 1
  dropout_rate         = 0.8
  learning_rate        = 0.002
  batch_size           = 32
  sequence_length      = 700
  epochs               = 15
  embedding_dim        = 50


✅ Mejor ROC AUC (val): 0.9459
   Épocas entrenadas: 10

======================================================================
ℐ Iteración 15/20
======================================================================

Parámetros:
  lstm_units           = 32
  num_lstm_layers      = 1
  dropout_rate         = 0.8
  learning_rate        = 0.002
  batch_size           = 32
  sequence_length      = 700
  epochs               = 30
  embedding_dim        = 100


✅ Mejor ROC AUC (val): 0.9434
   Épocas entrenadas: 12

======================================================================
ℐ Iteración 16/20
======================================================================

Parámetros:
  lstm_units           = 64
  num_lstm_layers      = 1
  dropout_rate         = 0.6
  learning_rate        = 0.001
  batch_size           = 64
  sequence_length      = 700
  epochs               = 15
  embedding_dim        = 50


✅ Mejor ROC AUC (val): 0.9268
   Épocas entrenadas: 15

======================================================================
ℐ Iteración 17/20
======================================================================

Parámetros:
  lstm_units           = 32
  num_lstm_layers      = 2
  dropout_rate         = 0.8
  learning_rate        = 0.002
  batch_size           = 64
  sequence_length      = 700
  epochs               = 30
  embedding_dim        = 100


✅ Mejor ROC AUC (val): 0.9331
   Épocas entrenadas: 20

======================================================================
ℐ Iteración 18/20
======================================================================

Parámetros:
  lstm_units           = 64
  num_lstm_layers      = 2
  dropout_rate         = 0.8
  learning_rate        = 0.001
  batch_size           = 32
  sequence_length      = 700
  epochs               = 30
  embedding_dim        = 100


✅ Mejor ROC AUC (val): 0.9407
   Épocas entrenadas: 16

======================================================================
ℐ Iteración 19/20
======================================================================

Parámetros:
  lstm_units           = 32
  num_lstm_layers      = 1
  dropout_rate         = 0.6
  learning_rate        = 0.001
  batch_size           = 64
  sequence_length      = 700
  epochs               = 15
  embedding_dim        = 50


✅ Mejor ROC AUC (val): 0.9241
   Épocas entrenadas: 15

======================================================================
ℐ Iteración 20/20
======================================================================

Parámetros:
  lstm_units           = 64
  num_lstm_layers      = 2
  dropout_rate         = 0.6
  learning_rate        = 0.002
  batch_size           = 64
  sequence_length      = 700
  epochs               = 30
  embedding_dim        = 100


✅ Mejor ROC AUC (val): 0.9333
   Épocas entrenadas: 11

======================================================================
📊 RESUMEN DE BÚSEDA
======================================================================

✅▒ Top 5 configuraciones:

1. ROC AUC: 0.9512
   lstm_units           = 64
   num_lstm_layers      = 1
   dropout_rate         = 0.6
   learning_rate        = 0.001
   batch_size           = 64
   sequence_length      = 700
   epochs               = 30
   embedding_dim        = 100

2. ROC AUC: 0.9499
   lstm_units           = 64
   num_lstm_layers      = 1
   dropout_rate         = 0.6
   learning_rate        = 0.002
   batch_size           = 64
   sequence_length      = 700
   epochs               = 30
   embedding_dim        = 100

3. ROC AUC: 0.9480
   lstm_units           = 64
   num_lstm_layers      = 2
   dropout_rate         = 0.6
   learning_rate        = 0.002
   batch_size           = 32
   sequence_length      = 700
   epochs               = 30
   embedding_dim        = 100

4. ROC AUC: 0.9480
   lstm_units           = 64
   num_lstm_layers      = 1
   dropout_rate         = 0.8
   learning_rate        = 0.002
   batch_size           = 64
   sequence_length      = 700
   epochs               = 30
   embedding_dim        = 100

5. ROC AUC: 0.9475
   lstm_units           = 64
   num_lstm_layers      = 1
   dropout_rate         = 0.8
   learning_rate        = 0.002
   batch_size           = 32
   sequence_length      = 700
   epochs               = 15
   embedding_dim        = 50

✅ MEJORES HIPERPARÁMETROS:
  lstm_units           = 64
  num_lstm_layers      = 1
  dropout_rate         = 0.6
  learning_rate        = 0.001
  batch_size           = 64
  sequence_length      = 700
  epochs               = 30
  embedding_dim        = 100

⌶̲⌶̲⌶̲⌶̲⌶̲⌶̲⌶̲ Mejor ROC AUC (validation): 0.9512

======================================================================
✂▒ EVALUACIÓN FINAL EN TEST SET
======================================================================

ℐ Recreando mejor modelo y evaluando en test...

✅ Embedding matrix: cobertura 54.5%

📊 MÉTRICAS EN TEST SET:

   Loss: 1.1554
   Accuracy: 0.6941
   F1-Score (macro): 0.6398
   F1-Score (weighted): 0.6775
   ROC AUC (OvR): 0.9458

======================================================================
REPORTE DE CLASIFICACIÓN DETALLADO
======================================================================

                        precision    recall  f1-score   support

            ACCOUNTANT     1.0000    1.0000    1.0000        12
              ADVOCATE     0.7857    0.9167    0.8462        12
           AGRICULTURE     0.3750    0.3333    0.3529         9
               APPAREL     0.1000    0.1000    0.1000        10
                  ARTS     0.5000    0.4000    0.4444        10
            AUTOMOBILE     0.2000    0.2000    0.2000         5
              AVIATION     0.4444    0.3333    0.3810        12
               BANKING     0.6000    0.5455    0.5714        11
                   BPO     0.0000    0.0000    0.0000         4
  BUSINESS-DEVELOPMENT     0.9231    1.0000    0.9600        12
                  CHEF     0.9091    0.8333    0.8696        12
          CONSTRUCTION     1.0000    0.7273    0.8421        11
            CONSULTANT     0.9000    0.8182    0.8571        11
              DESIGNER     0.7333    1.0000    0.8462        11
         DIGITAL-MEDIA     0.4615    0.6000    0.5217        10
           ENGINEERING     0.7333    0.9167    0.8148        12
               FINANCE     0.9167    0.9167    0.9167        12
               FITNESS     0.2000    0.0833    0.1176        12
            HEALTHCARE     0.3846    0.4545    0.4167        11
                    HR     0.9167    1.0000    0.9565        11
INFORMATION-TECHNOLOGY     0.8462    0.9167    0.8800        12
      PUBLIC-RELATIONS     0.7000    0.6364    0.6667        11
                 SALES     0.8571    1.0000    0.9231        12
               TEACHER     0.7692    1.0000    0.8696        10

              accuracy                         0.6941       255
             macro avg     0.6357    0.6555    0.6398       255
          weighted avg     0.6731    0.6941    0.6775       255


📊 Generando matriz de confusión...
</pre></div>
</div>
<img alt="_images/0ab50fe3c57a4856ef66bb24c424033d9865f71d500d4f90c85fc01cfd149cc2.png" src="_images/0ab50fe3c57a4856ef66bb24c424033d9865f71d500d4f90c85fc01cfd149cc2.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>↗▒ Generando gráficas de entrenamiento...
</pre></div>
</div>
<img alt="_images/b87e6e1f26fead7165d06c09b16f74c3393d561469a3b94d202f27149bec56e4.png" src="_images/b87e6e1f26fead7165d06c09b16f74c3393d561469a3b94d202f27149bec56e4.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>|▒ Guardando modelo y artefactos...

✅ Modelo guardado en: bilstm_model_best.pth
✅ Word2Vec guardado: word22vec_model.bin
✅ Resultados guardados: bilstm_search_results.json

======================================================================
✨▒ PROCESO COMPLETADO - WORD2VEC + BiLSTM CON TUNING
======================================================================
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title bert</span>
<span class="n">training_configs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;text_column&quot;</span><span class="p">:</span> <span class="s2">&quot;text_basic&quot;</span><span class="p">,</span>
        <span class="s2">&quot;output_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;./results_distilbert_basic&quot;</span><span class="p">,</span>
        <span class="s2">&quot;plot_title&quot;</span><span class="p">:</span> <span class="s2">&quot;Matriz de Confusión - DistilBERT (text_basic)&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;text_column&quot;</span><span class="p">:</span> <span class="s2">&quot;text_medium&quot;</span><span class="p">,</span>
        <span class="s2">&quot;output_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;./results_distilbert_medium&quot;</span><span class="p">,</span>
        <span class="s2">&quot;plot_title&quot;</span><span class="p">:</span> <span class="s2">&quot;Matriz de Confusión - DistilBERT (text_medium)&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;text_column&quot;</span><span class="p">:</span> <span class="s2">&quot;text_advanced&quot;</span><span class="p">,</span>
        <span class="s2">&quot;output_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;./results_distilbert_advanced&quot;</span><span class="p">,</span>
        <span class="s2">&quot;plot_title&quot;</span><span class="p">:</span> <span class="s2">&quot;Matriz de Confusión - DistilBERT (text_advanced)&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="n">MODEL_NAME</span> <span class="o">=</span> <span class="s2">&quot;distilbert-base-uncased&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;💻 Dispositivo: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">training_configs</span><span class="p">:</span>
    <span class="n">text_column</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;text_column&quot;</span><span class="p">]</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]</span>
    <span class="n">plot_title</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;plot_title&quot;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🚀 Iniciando entrenamiento para: </span><span class="si">{</span><span class="n">text_column</span><span class="si">}</span><span class="s2"> con </span><span class="si">{</span><span class="n">MODEL_NAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span>
     <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
     <span class="n">label_encoder</span><span class="p">,</span> <span class="n">num_labels</span><span class="p">,</span>
     <span class="n">class_weights_numpy</span><span class="p">,</span> <span class="n">class_weights_tensor</span><span class="p">,</span>
     <span class="n">sample_weights_train</span><span class="p">)</span> <span class="o">=</span> <span class="n">prepare_data_for_training</span><span class="p">(</span>
        <span class="n">data_for_models</span><span class="p">,</span> <span class="n">text_column</span><span class="p">,</span> <span class="s2">&quot;Category&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">group_ids</span><span class="o">=</span><span class="n">original_ids_for_models</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📊 ANÁLISIS DE DESBALANCE DE CLASES (Usando datos originales para referencia)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">class_distribution</span> <span class="o">=</span> <span class="n">data_for_models</span><span class="p">[</span><span class="s1">&#39;Category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Distribución de clases (original):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">class_distribution</span><span class="p">)</span>
    <span class="n">imbalance_ratio</span> <span class="o">=</span> <span class="n">class_distribution</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">class_distribution</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ Ratio de desbalance: </span><span class="si">{</span><span class="n">imbalance_ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔤 Tokenizando textos...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">MODEL_NAME</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_data</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="n">texts_as_list_of_str</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>
        <span class="n">encodings</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span>
            <span class="n">texts_as_list_of_str</span><span class="p">,</span>
            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">max_length</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s1">&#39;pt&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">encodings</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="n">train_encodings</span><span class="p">,</span> <span class="n">train_labels</span> <span class="o">=</span> <span class="n">tokenize_data</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">val_encodings</span><span class="p">,</span> <span class="n">val_labels</span> <span class="o">=</span> <span class="n">tokenize_data</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
    <span class="n">test_encodings</span><span class="p">,</span> <span class="n">test_labels</span> <span class="o">=</span> <span class="n">tokenize_data</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Tokenización completada&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Longitud máxima: </span><span class="si">{</span><span class="n">train_encodings</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> tokens</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">ResumeDataset</span><span class="p">(</span><span class="n">train_encodings</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span>
    <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">ResumeDataset</span><span class="p">(</span><span class="n">val_encodings</span><span class="p">,</span> <span class="n">val_labels</span><span class="p">)</span>
    <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">ResumeDataset</span><span class="p">(</span><span class="n">test_encodings</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span>


    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🦾 Cargando modelo: </span><span class="si">{</span><span class="n">MODEL_NAME</span><span class="si">}</span><span class="s2">...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
        <span class="n">MODEL_NAME</span><span class="p">,</span>
        <span class="n">num_labels</span><span class="o">=</span><span class="n">num_labels</span><span class="p">,</span>
        <span class="n">problem_type</span><span class="o">=</span><span class="s2">&quot;single_label_classification&quot;</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">class_weights_tensor</span> <span class="o">=</span> <span class="n">class_weights_tensor</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>


    <span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>

        <span class="n">num_train_epochs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>

        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">3e-5</span><span class="p">,</span>
        <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">warmup_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>

        <span class="n">eval_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
        <span class="n">save_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
        <span class="n">load_best_model_at_end</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">metric_for_best_model</span><span class="o">=</span><span class="s2">&quot;roc_auc_ovr&quot;</span><span class="p">,</span>
        <span class="n">greater_is_better</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>

        <span class="n">logging_dir</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;./logs_</span><span class="si">{</span><span class="n">text_column</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">logging_steps</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">report_to</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>

        <span class="n">save_total_limit</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>

        <span class="n">fp16</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">(),</span>
        <span class="n">dataloader_num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">42</span>
    <span class="p">)</span>


    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🚀 Iniciando entrenamiento...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>

    <span class="n">trainer</span> <span class="o">=</span> <span class="n">WeightedTrainer</span><span class="p">(</span>
        <span class="n">class_weights</span><span class="o">=</span><span class="n">class_weights_tensor</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
        <span class="n">eval_dataset</span><span class="o">=</span><span class="n">val_dataset</span><span class="p">,</span>
        <span class="n">compute_metrics</span><span class="o">=</span><span class="n">compute_metrics</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">EarlyStoppingCallback</span><span class="p">(</span><span class="n">early_stopping_patience</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">early_stopping_metric</span><span class="o">=</span><span class="s2">&quot;roc_auc_ovr&quot;</span><span class="p">,</span> <span class="n">greater_is_better</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
    <span class="p">)</span>

    <span class="n">train_result</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">✅ Entrenamiento completado</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>


    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📈 Evaluando en Test Set...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">predictions</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;REPORTE DE CLASIFICACIÓN:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span>
        <span class="n">y_test</span><span class="p">,</span>
        <span class="n">y_pred</span><span class="p">,</span>
        <span class="n">target_names</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span>
        <span class="n">digits</span><span class="o">=</span><span class="mi">4</span>
    <span class="p">))</span>

    <span class="n">test_accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">test_f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
    <span class="n">test_f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>

    <span class="n">test_logits</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">predictions</span>
    <span class="n">test_probabilities</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">test_logits</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">num_labels_test</span> <span class="o">=</span> <span class="n">test_logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">test_labels_one_hot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">num_labels_test</span><span class="p">)[</span><span class="n">y_test</span><span class="p">]</span>
    <span class="n">test_roc_auc_ovr</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">test_labels_one_hot</span><span class="p">,</span> <span class="n">test_probabilities</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📊 MÉTRICAS FINALES EN TEST (</span><span class="si">{</span><span class="n">text_column</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   • Accuracy: </span><span class="si">{</span><span class="n">test_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   • F1-Score (macro): </span><span class="si">{</span><span class="n">test_f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   • F1-Score (weighted): </span><span class="si">{</span><span class="n">test_f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   • ROC AUC (OvR): </span><span class="si">{</span><span class="n">test_roc_auc_ovr</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
        <span class="n">cm</span><span class="p">,</span>
        <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span>
        <span class="n">xticklabels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span>
        <span class="n">yticklabels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span>
    <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Verdadero&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicho&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;💾 Guardando modelo para </span><span class="si">{</span><span class="n">text_column</span><span class="si">}</span><span class="s2">...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="n">tokenizer</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="n">label_encoder_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">label</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;label_mapping.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">label_encoder_mapping</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Modelo guardado en: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>⟳ Preparando datos iniciales con get_data_for_models...

✔ Iniciando pipeline de preparacion de datos para modelos...
   [INFO] Google Drive ya montado.

✔ Intentando cargar dataframe aumentado desde Google Drive: /content/drive/MyDrive/data_augmented_processed.csv
✅ Dataframe aumentado cargado desde Google Drive: 2621 filas, 8 columnas.
   ✓ &#39;text_medium&#39; columna llenada/regenerada para 1 filas.
   ✓ &#39;text_advanced&#39; columna llenada/regenerada para 1 filas.
   ✀ Total de filas afectadas por la regeneracion de columnas: 2 (Detalles: &#39;text_medium&#39; (1 nulls), &#39;text_advanced&#39; (1 nulls))

✅ Pipeline de preparacion de datos completado.
✅ Datos cargados y listos para los modelos.
💻 Dispositivo: cuda

======================================================================
🚀 Iniciando entrenamiento para: text_basic con distilbert-base-uncased
======================================================================


======================================================
░░ PREPARANDO DATOS (SPLIT, ENCODING, PESOS DE CLASE)
========================================================

Clases detectadas: 24
Mapping de clases: {i: label for i, label in enumerate(label_encoder.classes_)}

░ Dataset: 2621 muestras
   Split: 80% train, 10% val, 10% test

✂️ Dividiendo datos usando Stratified Shuffle Split on unique groups (data leakage prevention and stratification)...
✅ Train: 2104 | Val: 262 | Test: 255

⚖️ Calculando pesos de clase para manejar desbalance...

Pesos por clase (entrenamiento):
  ACCOUNTANT           → peso: 0.933 (n=94)
  ADVOCATE             → peso: 0.933 (n=94)
  AGRICULTURE          → peso: 1.154 (n=76)
  APPAREL              → peso: 1.139 (n=77)
  ARTS                 → peso: 1.056 (n=83)
  AUTOMOBILE           → peso: 1.056 (n=83)
  AVIATION             → peso: 0.943 (n=93)
  BANKING              → peso: 0.953 (n=92)
  BPO                  → peso: 1.538 (n=57)
  BUSINESS-DEVELOPMENT → peso: 0.913 (n=96)
  CHEF                 → peso: 0.933 (n=94)
  CONSTRUCTION         → peso: 0.974 (n=90)
  CONSULTANT           → peso: 0.943 (n=93)
  DESIGNER             → peso: 1.031 (n=85)
  DIGITAL-MEDIA        → peso: 1.139 (n=77)
  ENGINEERING          → peso: 0.933 (n=94)
  FINANCE              → peso: 0.933 (n=94)
  FITNESS              → peso: 0.943 (n=93)
  HEALTHCARE           → peso: 0.953 (n=92)
  HR                   → peso: 0.996 (n=88)
  INFORMATION-TECHNOLOGY → peso: 0.913 (n=96)
  PUBLIC-RELATIONS     → peso: 0.985 (n=89)
  SALES                → peso: 0.953 (n=92)
  TEACHER              → peso: 1.069 (n=82)

========================================================

📊 ANÁLISIS DE DESBALANCE DE CLASES (Usando datos originales para referencia)


Distribución de clases (original):

Category
INFORMATION-TECHNOLOGY    120
BUSINESS-DEVELOPMENT      120
ADVOCATE                  118
CHEF                      118
ENGINEERING               118
ACCOUNTANT                118
FINANCE                   118
FITNESS                   117
AVIATION                  117
SALES                     116
BANKING                   115
HEALTHCARE                115
CONSULTANT                115
CONSTRUCTION              112
PUBLIC-RELATIONS          111
HR                        110
DESIGNER                  107
ARTS                      103
TEACHER                   102
APPAREL                    97
AGRICULTURE                96
DIGITAL-MEDIA              96
AUTOMOBILE                 96
BPO                        66
Name: count, dtype: int64

⚠️ Ratio de desbalance: 1.82x
======================================================================

🔤 Tokenizando textos...

✅ Tokenización completada
   Longitud máxima: 512 tokens

🦾 Cargando modelo: distilbert-base-uncased...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Some weights of DistilBertForSequenceClassification were not initialized from the model checkpoint at distilbert-base-uncased and are newly initialized: [&#39;classifier.bias&#39;, &#39;classifier.weight&#39;, &#39;pre_classifier.bias&#39;, &#39;pre_classifier.weight&#39;]
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🚀 Iniciando entrenamiento...

======================================================================
</pre></div>
</div>
<div class="output text_html">
    <div>
      
      <progress value='528' max='528' style='width:300px; height:20px; vertical-align: middle;'></progress>
      [528/528 02:39, Epoch 4/4]
    </div>
    <table border="1" class="dataframe">
  <thead>
 <tr style="text-align: left;">
      <th>Epoch</th>
      <th>Training Loss</th>
      <th>Validation Loss</th>
      <th>Accuracy</th>
      <th>F1 Macro</th>
      <th>F1 Weighted</th>
      <th>Roc Auc Ovr</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>2.450600</td>
      <td>1.337620</td>
      <td>0.744275</td>
      <td>0.664813</td>
      <td>0.697445</td>
      <td>0.949324</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.800700</td>
      <td>0.718890</td>
      <td>0.809160</td>
      <td>0.776556</td>
      <td>0.801113</td>
      <td>0.969823</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.454800</td>
      <td>0.612844</td>
      <td>0.820611</td>
      <td>0.790631</td>
      <td>0.816948</td>
      <td>0.973102</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.331400</td>
      <td>0.598250</td>
      <td>0.820611</td>
      <td>0.788285</td>
      <td>0.815433</td>
      <td>0.972771</td>
    </tr>
  </tbody>
</table><p></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Entrenamiento completado

======================================================================

📈 Evaluando en Test Set...
</pre></div>
</div>
<div class="output text_html"></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>REPORTE DE CLASIFICACIÓN:

                        precision    recall  f1-score   support

            ACCOUNTANT     1.0000    1.0000    1.0000        12
              ADVOCATE     0.9231    1.0000    0.9600        12
           AGRICULTURE     0.9000    1.0000    0.9474         9
               APPAREL     0.6000    0.6000    0.6000        10
                  ARTS     0.7000    0.7000    0.7000        10
            AUTOMOBILE     0.5000    0.4000    0.4444         5
              AVIATION     1.0000    0.7500    0.8571        12
               BANKING     1.0000    0.7273    0.8421        11
                   BPO     0.1667    0.2500    0.2000         4
  BUSINESS-DEVELOPMENT     0.8571    1.0000    0.9231        12
                  CHEF     0.9000    0.7500    0.8182        12
          CONSTRUCTION     1.0000    1.0000    1.0000        11
            CONSULTANT     0.9167    1.0000    0.9565        11
              DESIGNER     1.0000    1.0000    1.0000        11
         DIGITAL-MEDIA     0.9000    0.9000    0.9000        10
           ENGINEERING     0.9231    1.0000    0.9600        12
               FINANCE     0.9231    1.0000    0.9600        12
               FITNESS     0.7778    0.5833    0.6667        12
            HEALTHCARE     0.6364    0.6364    0.6364        11
                    HR     1.0000    1.0000    1.0000        11
INFORMATION-TECHNOLOGY     0.9167    0.9167    0.9167        12
      PUBLIC-RELATIONS     0.6923    0.8182    0.7500        11
                 SALES     0.9231    1.0000    0.9600        12
               TEACHER     0.9000    0.9000    0.9000        10

              accuracy                         0.8588       255
             macro avg     0.8357    0.8305    0.8291       255
          weighted avg     0.8655    0.8588    0.8582       255


======================================================================
📊 MÉTRICAS FINALES EN TEST (text_basic):
   • Accuracy: 0.8588
   • F1-Score (macro): 0.8291
   • F1-Score (weighted): 0.8582
   • ROC AUC (OvR): 0.9695
======================================================================
</pre></div>
</div>
<img alt="_images/4f92c47c234256c6631cd2f3b4d494a5c90a4df6432a54fc73b81b556e0439aa.png" src="_images/4f92c47c234256c6631cd2f3b4d494a5c90a4df6432a54fc73b81b556e0439aa.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>💾 Guardando modelo para text_basic...

✅ Modelo guardado en: ./results_distilbert_basic

======================================================================

======================================================================
🚀 Iniciando entrenamiento para: text_medium con distilbert-base-uncased
======================================================================


======================================================
░░ PREPARANDO DATOS (SPLIT, ENCODING, PESOS DE CLASE)
========================================================

Clases detectadas: 24
Mapping de clases: {i: label for i, label in enumerate(label_encoder.classes_)}

░ Dataset: 2621 muestras
   Split: 80% train, 10% val, 10% test

✂️ Dividiendo datos usando Stratified Shuffle Split on unique groups (data leakage prevention and stratification)...
✅ Train: 2104 | Val: 262 | Test: 255

⚖️ Calculando pesos de clase para manejar desbalance...

Pesos por clase (entrenamiento):
  ACCOUNTANT           → peso: 0.933 (n=94)
  ADVOCATE             → peso: 0.933 (n=94)
  AGRICULTURE          → peso: 1.154 (n=76)
  APPAREL              → peso: 1.139 (n=77)
  ARTS                 → peso: 1.056 (n=83)
  AUTOMOBILE           → peso: 1.056 (n=83)
  AVIATION             → peso: 0.943 (n=93)
  BANKING              → peso: 0.953 (n=92)
  BPO                  → peso: 1.538 (n=57)
  BUSINESS-DEVELOPMENT → peso: 0.913 (n=96)
  CHEF                 → peso: 0.933 (n=94)
  CONSTRUCTION         → peso: 0.974 (n=90)
  CONSULTANT           → peso: 0.943 (n=93)
  DESIGNER             → peso: 1.031 (n=85)
  DIGITAL-MEDIA        → peso: 1.139 (n=77)
  ENGINEERING          → peso: 0.933 (n=94)
  FINANCE              → peso: 0.933 (n=94)
  FITNESS              → peso: 0.943 (n=93)
  HEALTHCARE           → peso: 0.953 (n=92)
  HR                   → peso: 0.996 (n=88)
  INFORMATION-TECHNOLOGY → peso: 0.913 (n=96)
  PUBLIC-RELATIONS     → peso: 0.985 (n=89)
  SALES                → peso: 0.953 (n=92)
  TEACHER              → peso: 1.069 (n=82)

========================================================

📊 ANÁLISIS DE DESBALANCE DE CLASES (Usando datos originales para referencia)


Distribución de clases (original):

Category
INFORMATION-TECHNOLOGY    120
BUSINESS-DEVELOPMENT      120
ADVOCATE                  118
CHEF                      118
ENGINEERING               118
ACCOUNTANT                118
FINANCE                   118
FITNESS                   117
AVIATION                  117
SALES                     116
BANKING                   115
HEALTHCARE                115
CONSULTANT                115
CONSTRUCTION              112
PUBLIC-RELATIONS          111
HR                        110
DESIGNER                  107
ARTS                      103
TEACHER                   102
APPAREL                    97
AGRICULTURE                96
DIGITAL-MEDIA              96
AUTOMOBILE                 96
BPO                        66
Name: count, dtype: int64

⚠️ Ratio de desbalance: 1.82x
======================================================================

🔤 Tokenizando textos...

✅ Tokenización completada
   Longitud máxima: 512 tokens

🦾 Cargando modelo: distilbert-base-uncased...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Some weights of DistilBertForSequenceClassification were not initialized from the model checkpoint at distilbert-base-uncased and are newly initialized: [&#39;classifier.bias&#39;, &#39;classifier.weight&#39;, &#39;pre_classifier.bias&#39;, &#39;pre_classifier.weight&#39;]
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🚀 Iniciando entrenamiento...

======================================================================
</pre></div>
</div>
<div class="output text_html">
    <div>
      
      <progress value='528' max='528' style='width:300px; height:20px; vertical-align: middle;'></progress>
      [528/528 02:53, Epoch 4/4]
    </div>
    <table border="1" class="dataframe">
  <thead>
 <tr style="text-align: left;">
      <th>Epoch</th>
      <th>Training Loss</th>
      <th>Validation Loss</th>
      <th>Accuracy</th>
      <th>F1 Macro</th>
      <th>F1 Weighted</th>
      <th>Roc Auc Ovr</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>2.453000</td>
      <td>1.318904</td>
      <td>0.763359</td>
      <td>0.682926</td>
      <td>0.716319</td>
      <td>0.945738</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.817900</td>
      <td>0.681643</td>
      <td>0.816794</td>
      <td>0.785134</td>
      <td>0.811530</td>
      <td>0.971330</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.465600</td>
      <td>0.552709</td>
      <td>0.847328</td>
      <td>0.820231</td>
      <td>0.846180</td>
      <td>0.971543</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.337700</td>
      <td>0.540092</td>
      <td>0.832061</td>
      <td>0.800637</td>
      <td>0.827223</td>
      <td>0.975840</td>
    </tr>
  </tbody>
</table><p></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Entrenamiento completado

======================================================================

📈 Evaluando en Test Set...
</pre></div>
</div>
<div class="output text_html"></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>REPORTE DE CLASIFICACIÓN:

                        precision    recall  f1-score   support

            ACCOUNTANT     1.0000    1.0000    1.0000        12
              ADVOCATE     0.8571    1.0000    0.9231        12
           AGRICULTURE     1.0000    1.0000    1.0000         9
               APPAREL     0.7500    0.6000    0.6667        10
                  ARTS     0.7273    0.8000    0.7619        10
            AUTOMOBILE     0.5000    0.4000    0.4444         5
              AVIATION     0.9091    0.8333    0.8696        12
               BANKING     1.0000    0.6364    0.7778        11
                   BPO     0.1429    0.2500    0.1818         4
  BUSINESS-DEVELOPMENT     1.0000    1.0000    1.0000        12
                  CHEF     1.0000    0.7500    0.8571        12
          CONSTRUCTION     1.0000    1.0000    1.0000        11
            CONSULTANT     0.9167    1.0000    0.9565        11
              DESIGNER     1.0000    0.9091    0.9524        11
         DIGITAL-MEDIA     0.8182    0.9000    0.8571        10
           ENGINEERING     0.8000    1.0000    0.8889        12
               FINANCE     1.0000    1.0000    1.0000        12
               FITNESS     0.8889    0.6667    0.7619        12
            HEALTHCARE     0.7000    0.6364    0.6667        11
                    HR     1.0000    1.0000    1.0000        11
INFORMATION-TECHNOLOGY     0.9167    0.9167    0.9167        12
      PUBLIC-RELATIONS     0.7143    0.9091    0.8000        11
                 SALES     0.9231    1.0000    0.9600        12
               TEACHER     0.9091    1.0000    0.9524        10

              accuracy                         0.8706       255
             macro avg     0.8531    0.8420    0.8415       255
          weighted avg     0.8835    0.8706    0.8712       255


======================================================================
📊 MÉTRICAS FINALES EN TEST (text_medium):
   • Accuracy: 0.8706
   • F1-Score (macro): 0.8415
   • F1-Score (weighted): 0.8712
   • ROC AUC (OvR): 0.9726
======================================================================
</pre></div>
</div>
<img alt="_images/f6431b89206f44eda1f0cbc83e361604c0450683a05810a509d7d5ae010a4bba.png" src="_images/f6431b89206f44eda1f0cbc83e361604c0450683a05810a509d7d5ae010a4bba.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>💾 Guardando modelo para text_medium...

✅ Modelo guardado en: ./results_distilbert_medium

======================================================================

======================================================================
🚀 Iniciando entrenamiento para: text_advanced con distilbert-base-uncased
======================================================================


======================================================
░░ PREPARANDO DATOS (SPLIT, ENCODING, PESOS DE CLASE)
========================================================

Clases detectadas: 24
Mapping de clases: {i: label for i, label in enumerate(label_encoder.classes_)}

░ Dataset: 2621 muestras
   Split: 80% train, 10% val, 10% test

✂️ Dividiendo datos usando Stratified Shuffle Split on unique groups (data leakage prevention and stratification)...
✅ Train: 2104 | Val: 262 | Test: 255

⚖️ Calculando pesos de clase para manejar desbalance...

Pesos por clase (entrenamiento):
  ACCOUNTANT           → peso: 0.933 (n=94)
  ADVOCATE             → peso: 0.933 (n=94)
  AGRICULTURE          → peso: 1.154 (n=76)
  APPAREL              → peso: 1.139 (n=77)
  ARTS                 → peso: 1.056 (n=83)
  AUTOMOBILE           → peso: 1.056 (n=83)
  AVIATION             → peso: 0.943 (n=93)
  BANKING              → peso: 0.953 (n=92)
  BPO                  → peso: 1.538 (n=57)
  BUSINESS-DEVELOPMENT → peso: 0.913 (n=96)
  CHEF                 → peso: 0.933 (n=94)
  CONSTRUCTION         → peso: 0.974 (n=90)
  CONSULTANT           → peso: 0.943 (n=93)
  DESIGNER             → peso: 1.031 (n=85)
  DIGITAL-MEDIA        → peso: 1.139 (n=77)
  ENGINEERING          → peso: 0.933 (n=94)
  FINANCE              → peso: 0.933 (n=94)
  FITNESS              → peso: 0.943 (n=93)
  HEALTHCARE           → peso: 0.953 (n=92)
  HR                   → peso: 0.996 (n=88)
  INFORMATION-TECHNOLOGY → peso: 0.913 (n=96)
  PUBLIC-RELATIONS     → peso: 0.985 (n=89)
  SALES                → peso: 0.953 (n=92)
  TEACHER              → peso: 1.069 (n=82)

========================================================

📊 ANÁLISIS DE DESBALANCE DE CLASES (Usando datos originales para referencia)


Distribución de clases (original):

Category
INFORMATION-TECHNOLOGY    120
BUSINESS-DEVELOPMENT      120
ADVOCATE                  118
CHEF                      118
ENGINEERING               118
ACCOUNTANT                118
FINANCE                   118
FITNESS                   117
AVIATION                  117
SALES                     116
BANKING                   115
HEALTHCARE                115
CONSULTANT                115
CONSTRUCTION              112
PUBLIC-RELATIONS          111
HR                        110
DESIGNER                  107
ARTS                      103
TEACHER                   102
APPAREL                    97
AGRICULTURE                96
DIGITAL-MEDIA              96
AUTOMOBILE                 96
BPO                        66
Name: count, dtype: int64

⚠️ Ratio de desbalance: 1.82x
======================================================================

🔤 Tokenizando textos...

✅ Tokenización completada
   Longitud máxima: 512 tokens

🦾 Cargando modelo: distilbert-base-uncased...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Some weights of DistilBertForSequenceClassification were not initialized from the model checkpoint at distilbert-base-uncased and are newly initialized: [&#39;classifier.bias&#39;, &#39;classifier.weight&#39;, &#39;pre_classifier.bias&#39;, &#39;pre_classifier.weight&#39;]
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🚀 Iniciando entrenamiento...

======================================================================
</pre></div>
</div>
<div class="output text_html">
    <div>
      
      <progress value='528' max='528' style='width:300px; height:20px; vertical-align: middle;'></progress>
      [528/528 02:39, Epoch 4/4]
    </div>
    <table border="1" class="dataframe">
  <thead>
 <tr style="text-align: left;">
      <th>Epoch</th>
      <th>Training Loss</th>
      <th>Validation Loss</th>
      <th>Accuracy</th>
      <th>F1 Macro</th>
      <th>F1 Weighted</th>
      <th>Roc Auc Ovr</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>2.599400</td>
      <td>1.519539</td>
      <td>0.725191</td>
      <td>0.641731</td>
      <td>0.673622</td>
      <td>0.935867</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.916900</td>
      <td>0.686872</td>
      <td>0.839695</td>
      <td>0.794155</td>
      <td>0.824934</td>
      <td>0.961346</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.521000</td>
      <td>0.559088</td>
      <td>0.847328</td>
      <td>0.813217</td>
      <td>0.843109</td>
      <td>0.967022</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.375800</td>
      <td>0.537871</td>
      <td>0.858779</td>
      <td>0.827015</td>
      <td>0.851828</td>
      <td>0.971931</td>
    </tr>
  </tbody>
</table><p></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Entrenamiento completado

======================================================================

📈 Evaluando en Test Set...
</pre></div>
</div>
<div class="output text_html"></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>REPORTE DE CLASIFICACIÓN:

                        precision    recall  f1-score   support

            ACCOUNTANT     1.0000    1.0000    1.0000        12
              ADVOCATE     0.9231    1.0000    0.9600        12
           AGRICULTURE     1.0000    1.0000    1.0000         9
               APPAREL     0.8571    0.6000    0.7059        10
                  ARTS     0.7273    0.8000    0.7619        10
            AUTOMOBILE     0.6667    0.4000    0.5000         5
              AVIATION     0.9167    0.9167    0.9167        12
               BANKING     1.0000    0.7273    0.8421        11
                   BPO     0.2500    0.2500    0.2500         4
  BUSINESS-DEVELOPMENT     0.9231    1.0000    0.9600        12
                  CHEF     0.9000    0.7500    0.8182        12
          CONSTRUCTION     1.0000    1.0000    1.0000        11
            CONSULTANT     0.9091    0.9091    0.9091        11
              DESIGNER     1.0000    0.9091    0.9524        11
         DIGITAL-MEDIA     0.7692    1.0000    0.8696        10
           ENGINEERING     0.8000    1.0000    0.8889        12
               FINANCE     1.0000    1.0000    1.0000        12
               FITNESS     0.7273    0.6667    0.6957        12
            HEALTHCARE     0.7500    0.8182    0.7826        11
                    HR     1.0000    1.0000    1.0000        11
INFORMATION-TECHNOLOGY     1.0000    0.9167    0.9565        12
      PUBLIC-RELATIONS     0.6667    0.7273    0.6957        11
                 SALES     0.8571    1.0000    0.9231        12
               TEACHER     0.9000    0.9000    0.9000        10

              accuracy                         0.8745       255
             macro avg     0.8560    0.8455    0.8453       255
          weighted avg     0.8785    0.8745    0.8718       255


======================================================================
📊 MÉTRICAS FINALES EN TEST (text_advanced):
   • Accuracy: 0.8745
   • F1-Score (macro): 0.8453
   • F1-Score (weighted): 0.8718
   • ROC AUC (OvR): 0.9756
======================================================================
</pre></div>
</div>
<img alt="_images/45d55b0be341dd4d63822c13e817fada7f62cbe5dbf40d07b8eff3c747c09366.png" src="_images/45d55b0be341dd4d63822c13e817fada7f62cbe5dbf40d07b8eff3c747c09366.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>💾 Guardando modelo para text_advanced...

✅ Modelo guardado en: ./results_distilbert_advanced

======================================================================
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title FastText Supervisado - Clasificación Directa (SIN XGBoost)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;WANDB_DISABLED&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">fasttext</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">roc_auc_score</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">nltk</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nltk.corpus</span><span class="w"> </span><span class="kn">import</span> <span class="n">stopwords</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nltk.stem</span><span class="w"> </span><span class="kn">import</span> <span class="n">WordNetLemmatizer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">html</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
    <span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;stopwords&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">WordNetLemmatizer</span><span class="p">()</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
    <span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;wordnet&#39;</span><span class="p">)</span>
    <span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;omw-1.4&#39;</span><span class="p">)</span>

<span class="n">stop_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">))</span>
<span class="n">lemmatizer</span> <span class="o">=</span> <span class="n">WordNetLemmatizer</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">clean_level_basic</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;[^&gt;]+&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;http\S+|www\S+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;－&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;—&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;–&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([a-zA-Z])\*([a-zA-Z])&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1 \2&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\x00-\x1F\x7F-\x9F]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">clean_level_medium</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">clean_level_basic</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\W_]+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">clean_level_advanced</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">clean_level_medium</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stop_words</span><span class="p">]</span>
    <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="n">lemmatizer</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="s1">&#39;v&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span>
    <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="n">lemmatizer</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span>
    <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Imports y funciones de limpieza completados</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Dispositivo: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📊 PREPARACIÓN DE DATOS PARA FASTTEXT SUPERVISADO&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">data_for_models</span><span class="p">,</span> <span class="n">original_ids_for_models</span> <span class="o">=</span> <span class="n">get_data_for_models</span><span class="p">()</span>

<span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span>
 <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
 <span class="n">label_encoder</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span>
 <span class="n">class_weights_numpy</span><span class="p">,</span> <span class="n">class_weights_tensor</span><span class="p">,</span>
 <span class="n">sample_weights_train</span><span class="p">)</span> <span class="o">=</span> <span class="n">prepare_data_for_training</span><span class="p">(</span>
    <span class="n">data_for_models</span><span class="p">,</span> <span class="s2">&quot;text_advanced&quot;</span><span class="p">,</span> <span class="s2">&quot;Category&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">group_ids</span><span class="o">=</span><span class="n">original_ids_for_models</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📈 Distribución de clases en training:&quot;</span><span class="p">)</span>
<span class="n">train_dist</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
<span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">train_dist</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">cls_name</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">cls_name</span><span class="si">:</span><span class="s2">25s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">count</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📝 Preparando archivos en formato FastText...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">preprocess_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39; . &#39;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39; , &#39;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="s1">&#39; ! &#39;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39; ? &#39;</span><span class="p">)</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^a-záéíóúñü0-9\s\.\,\!\?]&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">text</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_fasttext_file</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
            <span class="n">label_name</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="n">processed_text</span> <span class="o">=</span> <span class="n">preprocess_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;__label__</span><span class="si">{</span><span class="n">label_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">processed_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔄 Creando archivos .txt...&quot;</span><span class="p">)</span>
<span class="n">create_fasttext_file</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="s1">&#39;train.txt&#39;</span><span class="p">)</span>
<span class="n">create_fasttext_file</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="s1">&#39;val.txt&#39;</span><span class="p">)</span>
<span class="n">create_fasttext_file</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="s1">&#39;test.txt&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Archivos creados: train.txt, val.txt, test.txt</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🚀 ENTRENAMIENTO FASTTEXT SUPERVISADO&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔄 Entrenando modelo FastText supervisado...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   (Esto puede tomar varios minutos)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">fasttext</span><span class="o">.</span><span class="n">train_supervised</span><span class="p">(</span>
    <span class="nb">input</span><span class="o">=</span><span class="s1">&#39;train.txt&#39;</span><span class="p">,</span>
    <span class="n">dim</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">ws</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">lr</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
    <span class="n">epoch</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">wordNgrams</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">minn</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">maxn</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;ova&#39;</span><span class="p">,</span>
    <span class="n">thread</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">lrUpdateRate</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">bucket</span><span class="o">=</span><span class="mi">2000000</span><span class="p">,</span>
    <span class="n">minCount</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">minCountLabel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">✅ Modelo FastText entrenado&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Vocabulario: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">words</span><span class="p">)</span><span class="si">}</span><span class="s2"> palabras&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Labels: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span><span class="si">}</span><span class="s2"> categorías&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Dimensión: 500</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📊 EVALUACIÓN EN VALIDATION SET&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">n_samples_val</span><span class="p">,</span> <span class="n">precision_val</span><span class="p">,</span> <span class="n">recall_val</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="s1">&#39;val.txt&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation Set (método .test()):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Samples:   </span><span class="si">{</span><span class="n">n_samples_val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Precision: </span><span class="si">{</span><span class="n">precision_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Recall:    </span><span class="si">{</span><span class="n">recall_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-score:  </span><span class="si">{</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">precision_val</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">recall_val</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">precision_val</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">recall_val</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔄 Generando predicciones detalladas en validation...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">predict_from_file</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">label_encoder</span><span class="p">):</span>
    <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">true_labels_names</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">true_label_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;__label__&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="n">true_labels_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">true_label_name</span><span class="p">)</span>

    <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
    <span class="n">all_pred_labels_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_pred_probas_ordered</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">class_name_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)}</span>

    <span class="k">for</span> <span class="n">text_raw</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="n">processed_text</span> <span class="o">=</span> <span class="n">preprocess_text</span><span class="p">(</span><span class="n">text_raw</span><span class="p">)</span>

        <span class="n">ft_labels_for_text</span><span class="p">,</span> <span class="n">ft_probas_for_text</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">processed_text</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">num_classes</span><span class="p">)</span>

        <span class="n">proba_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ft_lbl</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ft_labels_for_text</span><span class="p">,</span> <span class="n">ft_probas_for_text</span><span class="p">):</span>
            <span class="n">clean_lbl</span> <span class="o">=</span> <span class="n">ft_lbl</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;__label__&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">clean_lbl</span> <span class="ow">in</span> <span class="n">class_name_to_idx</span><span class="p">:</span>
                <span class="n">idx_in_ordered</span> <span class="o">=</span> <span class="n">class_name_to_idx</span><span class="p">[</span><span class="n">clean_lbl</span><span class="p">]</span>
                <span class="n">proba_vector</span><span class="p">[</span><span class="n">idx_in_ordered</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span>

        <span class="n">all_pred_probas_ordered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proba_vector</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ft_labels_for_text</span><span class="p">:</span>
            <span class="n">top_pred_label_name</span> <span class="o">=</span> <span class="n">ft_labels_for_text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;__label__&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">all_pred_labels_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_pred_label_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_pred_labels_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">true_labels_names</span><span class="p">,</span> <span class="n">all_pred_labels_names</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_pred_probas_ordered</span><span class="p">)</span>

<span class="n">y_val_true_names</span><span class="p">,</span> <span class="n">y_val_pred_names</span><span class="p">,</span> <span class="n">y_val_pred_probas</span> <span class="o">=</span> <span class="n">predict_from_file</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;val.txt&#39;</span><span class="p">,</span> <span class="n">label_encoder</span><span class="p">)</span>

<span class="n">y_val_true_idx</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">y_val_true_names</span><span class="p">]</span>
<span class="n">y_val_pred_idx</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">y_val_pred_names</span><span class="p">]</span>

<span class="n">val_accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_val_true_idx</span><span class="p">,</span> <span class="n">y_val_pred_idx</span><span class="p">)</span>
<span class="n">val_f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_val_true_idx</span><span class="p">,</span> <span class="n">y_val_pred_idx</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">val_f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_val_true_idx</span><span class="p">,</span> <span class="n">y_val_pred_idx</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">val_labels_one_hot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)[</span><span class="n">y_val_true_idx</span><span class="p">]</span>
<span class="n">val_roc_auc_ovr</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">val_labels_one_hot</span><span class="p">,</span> <span class="n">y_val_pred_probas</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Métricas detalladas en Validation:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy:    </span><span class="si">{</span><span class="n">val_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-macro:    </span><span class="si">{</span><span class="n">val_f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-weighted: </span><span class="si">{</span><span class="n">val_f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ROC AUC (OvR): </span><span class="si">{</span><span class="n">val_roc_auc_ovr</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🧪 EVALUACIÓN EN TEST SET&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">n_samples_test</span><span class="p">,</span> <span class="n">precision_test</span><span class="p">,</span> <span class="n">recall_test</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="s1">&#39;test.txt&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test Set (método .test()):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Samples:   </span><span class="si">{</span><span class="n">n_samples_test</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Precision: </span><span class="si">{</span><span class="n">precision_test</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Recall:    </span><span class="si">{</span><span class="n">recall_test</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-score:  </span><span class="si">{</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">precision_test</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">recall_test</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">precision_test</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">recall_test</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">y_test_true_names</span><span class="p">,</span> <span class="n">y_test_pred_names</span><span class="p">,</span> <span class="n">y_test_pred_probas</span> <span class="o">=</span> <span class="n">predict_from_file</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;test.txt&#39;</span><span class="p">,</span> <span class="n">label_encoder</span><span class="p">)</span>

<span class="n">y_test_true_idx</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">y_test_true_names</span><span class="p">]</span>
<span class="n">y_test_pred_idx</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">y_test_pred_names</span><span class="p">]</span>

<span class="n">test_accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test_true_idx</span><span class="p">,</span> <span class="n">y_test_pred_idx</span><span class="p">)</span>
<span class="n">test_f1_macro</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test_true_idx</span><span class="p">,</span> <span class="n">y_test_pred_idx</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_f1_weighted</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test_true_idx</span><span class="p">,</span> <span class="n">y_test_pred_idx</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">test_labels_one_hot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)[</span><span class="n">y_test_true_idx</span><span class="p">]</span>
<span class="n">test_roc_auc_ovr</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">test_labels_one_hot</span><span class="p">,</span> <span class="n">y_test_pred_probas</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📊 MÉTRICAS FINALES EN TEST:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Accuracy:    </span><span class="si">{</span><span class="n">test_accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-macro:    </span><span class="si">{</span><span class="n">test_f1_macro</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   F1-weighted: </span><span class="si">{</span><span class="n">test_f1_weighted</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ROC AUC (OvR): </span><span class="si">{</span><span class="n">test_roc_auc_ovr</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span>
    <span class="n">y_test_true_idx</span><span class="p">,</span>
    <span class="n">y_test_pred_idx</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_classes</span><span class="p">),</span>
    <span class="n">target_names</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span>
    <span class="n">digits</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span>
<span class="p">))</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📈 MATRIZ DE CONFUSIÓN&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test_true_idx</span><span class="p">,</span> <span class="n">y_test_pred_idx</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_classes</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span>
            <span class="n">xticklabels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span>
            <span class="n">yticklabels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span>
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Número de predicciones&#39;</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Matriz de Confusión - FastText Supervisado&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Verdadero&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicho&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">💾 Guardando modelo...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="s1">&#39;fasttext_supervised_model.bin&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Modelo guardado: fasttext_supervised_model.bin&quot;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;fasttext_label_encoder.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">label_encoder</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Label encoder guardado: fasttext_label_encoder.pkl&quot;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fasttext_supervised&#39;</span><span class="p">,</span>
    <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
    <span class="s1">&#39;ws&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
    <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="s1">&#39;wordNgrams&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s1">&#39;minn&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;maxn&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="s1">&#39;ova&#39;</span><span class="p">,</span>
    <span class="s1">&#39;num_classes&#39;</span><span class="p">:</span> <span class="n">num_classes</span><span class="p">,</span>
    <span class="s1">&#39;class_names&#39;</span><span class="p">:</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="s1">&#39;test_accuracy&#39;</span><span class="p">:</span> <span class="n">test_accuracy</span><span class="p">,</span>
    <span class="s1">&#39;test_f1_macro&#39;</span><span class="p">:</span> <span class="n">test_f1_macro</span><span class="p">,</span>
    <span class="s1">&#39;test_f1_weighted&#39;</span><span class="p">:</span> <span class="n">test_f1_weighted</span><span class="p">,</span>
    <span class="s1">&#39;test_roc_auc_ovr&#39;</span><span class="p">:</span> <span class="n">test_roc_auc_ovr</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;fasttext_model_config.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Configuracion guardada: fasttext_model_config.json&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🎉 PROCESO COMPLETADO&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📌 Para cargar el modelo posteriormente:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   model = fasttext.load_model(&#39;fasttext_supervised_model.bin&#39;)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   predictions = model.predict(&#39;tu texto aquí&#39;, k=3)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Imports y funciones de limpieza completados

[INFO] Dispositivo: cpu

======================================================================
📊 PREPARACIÓN DE DATOS PARA FASTTEXT SUPERVISADO
======================================================================


✔ Iniciando pipeline de preparacion de datos para modelos...
   [INFO] Google Drive ya montado.

✔ Intentando cargar dataframe aumentado desde Google Drive: /content/drive/MyDrive/data_augmented_processed.csv
✅ Dataframe aumentado cargado desde Google Drive: 2621 filas, 8 columnas.
   ✓ &#39;text_medium&#39; columna llenada/regenerada para 1 filas.
   ✓ &#39;text_advanced&#39; columna llenada/regenerada para 1 filas.
   ✀ Total de filas afectadas por la regeneracion de columnas: 2 (Detalles: &#39;text_medium&#39; (1 nulls), &#39;text_advanced&#39; (1 nulls))

   ✔ DataFrame actualizado y guardado en Google Drive: /content/drive/MyDrive/data_augmented_processed.csv
✅ Pipeline de preparacion de datos completado.

======================================================
░░ PREPARANDO DATOS (SPLIT, ENCODING, PESOS DE CLASE)
========================================================

Clases detectadas: 24
Mapping de clases: {i: label for i, label in enumerate(label_encoder.classes_)}

░ Dataset: 2621 muestras
   Split: 80% train, 10% val, 10% test

✂️ Dividiendo datos usando Stratified Shuffle Split on unique groups (data leakage prevention and stratification)...
✅ Train: 2104 | Val: 262 | Test: 255

⚖️ Calculando pesos de clase para manejar desbalance...

Pesos por clase (entrenamiento):
  ACCOUNTANT           → peso: 0.933 (n=94)
  ADVOCATE             → peso: 0.933 (n=94)
  AGRICULTURE          → peso: 1.154 (n=76)
  APPAREL              → peso: 1.139 (n=77)
  ARTS                 → peso: 1.056 (n=83)
  AUTOMOBILE           → peso: 1.056 (n=83)
  AVIATION             → peso: 0.943 (n=93)
  BANKING              → peso: 0.953 (n=92)
  BPO                  → peso: 1.538 (n=57)
  BUSINESS-DEVELOPMENT → peso: 0.913 (n=96)
  CHEF                 → peso: 0.933 (n=94)
  CONSTRUCTION         → peso: 0.974 (n=90)
  CONSULTANT           → peso: 0.943 (n=93)
  DESIGNER             → peso: 1.031 (n=85)
  DIGITAL-MEDIA        → peso: 1.139 (n=77)
  ENGINEERING          → peso: 0.933 (n=94)
  FINANCE              → peso: 0.933 (n=94)
  FITNESS              → peso: 0.943 (n=93)
  HEALTHCARE           → peso: 0.953 (n=92)
  HR                   → peso: 0.996 (n=88)
  INFORMATION-TECHNOLOGY → peso: 0.913 (n=96)
  PUBLIC-RELATIONS     → peso: 0.985 (n=89)
  SALES                → peso: 0.953 (n=92)
  TEACHER              → peso: 1.069 (n=82)

========================================================

📈 Distribución de clases en training:
   ACCOUNTANT               :   94 (4.5%)
   ADVOCATE                 :   94 (4.5%)
   AGRICULTURE              :   76 (3.6%)
   APPAREL                  :   77 (3.7%)
   ARTS                     :   83 (3.9%)
   AUTOMOBILE               :   83 (3.9%)
   AVIATION                 :   93 (4.4%)
   BANKING                  :   92 (4.4%)
   BPO                      :   57 (2.7%)
   BUSINESS-DEVELOPMENT     :   96 (4.6%)
   CHEF                     :   94 (4.5%)
   CONSTRUCTION             :   90 (4.3%)
   CONSULTANT               :   93 (4.4%)
   DESIGNER                 :   85 (4.0%)
   DIGITAL-MEDIA            :   77 (3.7%)
   ENGINEERING              :   94 (4.5%)
   FINANCE                  :   94 (4.5%)
   FITNESS                  :   93 (4.4%)
   HEALTHCARE               :   92 (4.4%)
   HR                       :   88 (4.2%)
   INFORMATION-TECHNOLOGY   :   96 (4.6%)
   PUBLIC-RELATIONS         :   89 (4.2%)
   SALES                    :   92 (4.4%)
   TEACHER                  :   82 (3.9%)

📝 Preparando archivos en formato FastText...

🔄 Creando archivos .txt...
✅ Archivos creados: train.txt, val.txt, test.txt

======================================================================
🚀 ENTRENAMIENTO FASTTEXT SUPERVISADO
======================================================================

🔄 Entrenando modelo FastText supervisado...
   (Esto puede tomar varios minutos)


✅ Modelo FastText entrenado
   Vocabulario: 32575 palabras
   Labels: 24 categorías
   Dimensión: 500

======================================================================
📊 EVALUACIÓN EN VALIDATION SET
======================================================================

Validation Set (método .test()):

   Samples:   262
   Precision: 0.4924
   Recall:    0.4924
   F1-score:  0.4924

🔄 Generando predicciones detalladas en validation...

Métricas detalladas en Validation:

   Accuracy:    0.4885
   F1-macro:    0.4249
   F1-weighted: 0.4461
   ROC AUC (OvR): 0.8907

======================================================================
🧪 EVALUACIÓN EN TEST SET
======================================================================

Test Set (método .test()):

   Samples:   255
   Precision: 0.5137
   Recall:    0.5137
   F1-score:  0.5137

📊 MÉTRICAS FINALES EN TEST:

   Accuracy:    0.5176
   F1-macro:    0.4675
   F1-weighted: 0.4921
   ROC AUC (OvR): 0.8793

                        precision    recall  f1-score   support

            ACCOUNTANT     0.5500    0.9167    0.6875        12
              ADVOCATE     0.3333    0.3333    0.3333        12
           AGRICULTURE     1.0000    0.2222    0.3636         9
               APPAREL     0.0000    0.0000    0.0000        10
                  ARTS     0.0000    0.0000    0.0000        10
            AUTOMOBILE     0.2500    0.4000    0.3077         5
              AVIATION     0.3333    0.3333    0.3333        12
               BANKING     0.7500    0.5455    0.6316        11
                   BPO     0.0000    0.0000    0.0000         4
  BUSINESS-DEVELOPMENT     0.4545    0.8333    0.5882        12
                  CHEF     0.7273    0.6667    0.6957        12
          CONSTRUCTION     0.7143    0.4545    0.5556        11
            CONSULTANT     0.2857    0.1818    0.2222        11
              DESIGNER     0.7500    0.8182    0.7826        11
         DIGITAL-MEDIA     0.4545    0.5000    0.4762        10
           ENGINEERING     0.7000    0.5833    0.6364        12
               FINANCE     0.8333    0.4167    0.5556        12
               FITNESS     0.6000    0.5000    0.5455        12
            HEALTHCARE     0.4286    0.5455    0.4800        11
                    HR     0.6429    0.8182    0.7200        11
INFORMATION-TECHNOLOGY     0.5714    1.0000    0.7273        12
      PUBLIC-RELATIONS     0.6364    0.6364    0.6364        11
                 SALES     0.4615    0.5000    0.4800        12
               TEACHER     0.3750    0.6000    0.4615        10

              accuracy                         0.5176       255
             macro avg     0.4938    0.4919    0.4675       255
          weighted avg     0.5161    0.5176    0.4921       255
</pre></div>
</div>
<img alt="_images/342af0eb650099b85d70d0c12f7fba2b2978c1008035aa92961f0d3060b154d4.png" src="_images/342af0eb650099b85d70d0c12f7fba2b2978c1008035aa92961f0d3060b154d4.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>💾 Guardando modelo...

✅ Modelo guardado: fasttext_supervised_model.bin
✅ Label encoder guardado: fasttext_label_encoder.pkl
✅ Configuracion guardada: fasttext_model_config.json
🎉 PROCESO COMPLETADO

📌 Para cargar el modelo posteriormente:
   model = fasttext.load_model(&#39;fasttext_supervised_model.bin&#39;)
   predictions = model.predict(&#39;tu texto aquí&#39;, k=3)
</pre></div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="distilbert_analysis.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Análisis del Modelo DistilBERT para Clasificación de Currículums</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="simple visible nav section-nav flex-column">
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Adriam Aristizabal
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>